<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="/assets/oneiron.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ONEIRON — Perfil de empresa (vista)</title>
  <style>
    :root{
      /* Paleta y tokens iguales que perfil.html */
      --bg:#f7f9fc; --card:#ffffffee; --glass:#ffffffb8; --soft:#f3f6fb80; --stroke:#d1d9e680; --text:#0f172a; --muted:#6b7280;
      --radius:16px; --shadow-xl:0 10px 30px rgba(20,24,60,.12), 0 2px 8px rgba(20,24,60,.08); --ring:0 0 0 6px rgba(79,70,229,.18);
      --ok:#16a34a; --err:#ef4444;
      --sidebar-w: 260px; --gap: 18px;

      /* MISMO alto que index/perfil editado */
      --banner-h: clamp(160px, 20vh, 360px);
      /* Desplazamiento del logo para que no “corte” con la barra superior (consistente con index) */
      --logo-shift: 18px;

      /* Colores clave (como en index) */
      --indigo-bright:#6366f1; 
      --indigo-bright-2:#818cf8;
      --sky:#38bdf8;
      --sky-2:#7dd3fc;

      /* Banner igual que index/perfil */
      --banner-start:#c7d2fe; 
      --banner-end:#a5b4fc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:var(--bg); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; overflow-x:hidden;
    }

    /* fondo onírico (idéntico) */
    .dream-bg{ position:fixed; inset:0; z-index:-3; overflow:hidden;
      background:
        radial-gradient(1200px 520px at 50% -5%, rgba(79,70,229,.22), transparent 60%),
        radial-gradient(900px 380px at 15% 100%, rgba(37,99,235,.22), transparent 60%),
        radial-gradient(700px 300px at 85% 90%, rgba(56,189,248,.18), transparent 60%),
        linear-gradient(#f9fbff, #f1f5ff 60%, #f7f9fc);
    }
    .stars,.grain{position:absolute; inset:0; pointer-events:none}
    .stars{ background-image:
      radial-gradient(1px 1px at 10% 20%, rgba(38,38,80,.6) 40%, transparent 41%),
      radial-gradient(1px 1px at 30% 70%, rgba(38,38,80,.5) 40%, transparent 41%),
      radial-gradient(1px 1px at 60% 30%, rgba(38,38,80,.55) 40%, transparent 41%),
      radial-gradient(1.2px 1.2px at 80% 60%, rgba(38,38,80,.45) 40%, transparent 41%),
      radial-gradient(0.9px 0.9px at 50% 85%, rgba(38,38,80,.45) 40%, transparent 41%); filter:blur(.2px); opacity:.55; }
    .grain{ mix-blend-mode:soft-light; opacity:.35;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="160" height="160" filter="url(%23n)" opacity="0.08"/></svg>');
      background-size:160px 160px; }
    .orb{position:absolute; filter:blur(24px); opacity:.35; border-radius:999px; will-change:transform; animation:drift 11s ease-in-out infinite;}
    .orb.one{width:380px; height:380px; left:-80px; top:10vh; background:radial-gradient(circle at 30% 30%, #93c5fd, transparent 60%)}
    .orb.two{width:420px; height:420px; right:-120px; top:45vh; background:radial-gradient(circle at 70% 40%, #a5b4fc, transparent 60%)}
    .orb.three{width:300px; height:300px; left:55vw; top:-120px; background:radial-gradient(circle at 30% 70%, #67e8f9, transparent 60%)}
    @keyframes drift{0%{transform:translate3d(0,0,0) rotate(0)}50%{transform:translate3d(0,12px,0) rotate(1deg)}100%{transform:translate3d(0,0,0) rotate(0)}}

    /* Layout general */
    .layout{ margin:0; padding:0 22px 80px; }

    /* Sidebar / Índice (igual, mantenemos botón Inicio) */
    .sidebar{
      position:fixed;
      top: var(--banner-h);
      left:0;
      width:var(--sidebar-w);
      height: calc(100vh - var(--banner-h));
      overflow:auto; scrollbar-gutter:stable;
      border:1px solid var(--stroke); border-left:0; border-radius:0 20px 20px 0;
      background:linear-gradient(180deg, var(--card), var(--soft)); box-shadow:var(--shadow-xl); padding:12px; z-index:9;
    }
    .side-title{ font-size:.85rem; color:var(--muted); margin:6px 8px; text-transform:uppercase; letter-spacing:.06em }
    .side-nav{ display:grid; gap:10px; }
    .side-nav a,
    .side-nav .btn-link{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; text-decoration:none; color:var(--text);
      border:1px solid var(--stroke); background:#fff; position:relative; justify-content:flex-start;
    }
    .side-nav a .left{display:flex; align-items:center; gap:8px}
    .side-nav a .icon{ width:18px; height:18px; opacity:.9 }
    .side-nav a:hover{ box-shadow:0 10px 18px rgba(79,70,229,.12) }
    .side-nav a.active{ outline:2px solid color-mix(in oklab, var(--indigo-bright) 35%, white 65%); background:linear-gradient(180deg, #fff, #f8fafc) }
    .side-nav .btn-primary{
      background:linear-gradient(135deg, var(--indigo-bright), var(--indigo-bright-2));
      color:#fff; border-color:transparent; font-weight:700; justify-content:center;
      box-shadow:0 10px 24px rgba(99,102,241,.25);
    }
    .side-nav .btn-primary:hover{ filter:brightness(1.05) saturate(1.02); }

    /* Panel de contenido */
    .panel{
      display:grid; gap:16px;
      margin-left: calc(var(--sidebar-w) + var(--gap));
      margin-top: var(--banner-h);
      max-width: none;
      margin-right: 22px;
    }

    .card{ border:1px solid var(--stroke); background:linear-gradient(180deg, var(--card), var(--soft)); border-radius:20px; box-shadow:var(--shadow-xl); overflow:hidden; }
    .section-hd{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--stroke); }
    .section-hd h2{ margin:0; font-size:1.05rem; letter-spacing:.2px }
    .section-bd{ padding:14px; }

    /* Banner fijo arriba (solo capa fija, sin card para evitar barra blanca) */
    .banner-wrap{
      position:fixed; top:0; left:0; width:100vw; height:var(--banner-h);
      background:linear-gradient(135deg, var(--banner-start), var(--banner-end));
      border-radius:0; display:grid; place-items:center; z-index:8;
    }
    .banner{ position:absolute; inset:0; background-size:cover; background-position:center; filter:saturate(1) contrast(1); }
    .banner-overlay{
      position:absolute; inset:0;
      /* igual que index/perfil (ligeramente más bajo) */
      background:radial-gradient(800px 260px at 50% 0%, rgba(255,255,255,.18), transparent 60%),
                 linear-gradient(to bottom, rgba(255,255,255,.15), rgba(255,255,255,.02));
      pointer-events:none;
    }
    .logo-on-banner{ position:absolute; inset:0; display:grid; place-items:center; }
    .logo-on-banner img{
      width: calc(var(--banner-h) * 0.46);
      height: calc(var(--banner-h) * 0.46);
      object-fit:contain; border-radius:24px; background:#fff; padding:12px;
      box-shadow:0 12px 30px rgba(15,23,42,.22);
      transform: translateY(var(--logo-shift)); /* baja el logo como en index */
    }

    /* Botón Compartir en el banner (abajo-derecha) */
    .share-btn{
      position:absolute; right:28px; bottom:14px;
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:14px; border:1px solid transparent;
      background:linear-gradient(135deg, var(--indigo-bright), var(--indigo-bright-2));
      color:#fff; font-weight:700; cursor:pointer;
      box-shadow:0 10px 24px rgba(99,102,241,.25);
    }
    .share-btn:hover{ filter:brightness(1.05) saturate(1.02); }

    .row{ display:grid; gap:10px; margin:10px 0 }
    .label{ font-size:.92rem; color:var(--muted) }

    /* RTE visual (solo lectura) */
    .rte-view{ line-height:1.7; }
    .rte-view a{ color:#2563eb; text-decoration:underline; word-break:break-word }

    /* Chips / etiquetas (sin acciones) */
    .chosen-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--stroke); background:linear-gradient(180deg, #fff, #f8fafc); padding:6px 10px; border-radius:999px; font-size:.9rem; }

    /* Tarjetas de items */
    .item-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .item-title{ font-weight:700; font-size:1rem; }
    .gallery-row{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px; }
    .gallery-row img{ height:110px; width:auto; object-fit:cover; border-radius:12px; border:1px solid var(--stroke); background:#fff; }
    .item-desc{ color:var(--muted); margin:.35rem 0 0; }
    .item-desc a{ color:#2563eb; text-decoration:underline; }

    .muted{ color:var(--muted) }
  </style>
</head>
<body>
  <div class="dream-bg" aria-hidden="true">
    <div class="orb one"></div>
    <div class="orb two"></div>
    <div class="orb three"></div>
    <div class="stars"></div>
    <div class="grain"></div>
  </div>

  <!-- Banner fijo arriba (sin card para evitar barra blanca) -->
  <div class="banner-wrap" id="banner-wrap">
    <div class="banner" id="banner" role="img" aria-label="Imagen de cabecera"></div>
    <div class="banner-overlay"></div>
    <div class="logo-on-banner"><img id="logo" alt="Logotipo" src="/assets/oneiron.png"></div>
    <button id="share-link" class="share-btn" title="Compartir perfil" type="button" aria-label="Compartir">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
        <path d="M8.59 13.51l6.83 3.98M15.41 6.51L8.59 10.49"/>
      </svg>
      Compartir
    </button>
  </div>

  <!-- Índice lateral (se eliminó el enlace “Compartir” del índice) -->
  <aside class="sidebar" aria-label="Índice">
    <div class="side-title">Navegación</div>
    <nav class="side-nav" id="side-nav">
      <a class="btn-link btn-primary" href="/" title="Volver al inicio">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>
          Inicio
        </span>
      </a>

      <a href="#sec-nombre">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
          Nombre
        </span>
      </a>

      <a href="#sec-desc">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M8 8h8M8 12h8M8 16h6"/></svg>
          Descripción
        </span>
      </a>

      <a href="#sec-tags">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10l-8 8-8-8 8-8 8 8z"/></svg>
          Etiquetas
        </span>
      </a>

      <a href="#sec-local">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21s-6-4.35-6-10a6 6 0 1112 0c0 5.65-6 10-6 10z"/><circle cx="12" cy="11" r="2"/></svg>
          Localización
        </span>
      </a>

      <a href="#sec-proyectos">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="14"/><path d="M3 17l4 4h10l4-4"/></svg>
          Proyectos
        </span>
      </a>

      <a href="#sec-productos">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 8l-9-4-9 4v8l9 4 9-4V8z"/>
            <path d="M12 12V4M3 8l9 4 9-4"/>
          </svg>
          Productos
        </span>
      </a>
    </nav>
  </aside>

  <main class="layout">
    <section class="panel">
      <!-- Nombre (solo lectura) -->
      <article class="card" id="sec-nombre" aria-label="Nombre de la empresa">
        <div class="section-hd"><h2>Nombre</h2></div>
        <div class="section-bd">
          <div class="row">
            <div class="label">Nombre de la empresa</div>
            <div id="company-name-view" style="font-weight:700; font-size:1.05rem">—</div>
          </div>
        </div>
      </article>

      <!-- Descripción (solo lectura) -->
      <article class="card" id="sec-desc" aria-label="Descripción de la empresa">
        <div class="section-hd">
          <h2>Descripción</h2>
          <small id="desc-count" style="color:var(--muted)">0 / 1000 palabras</small>
        </div>
        <div class="section-bd">
          <div id="company-desc-view" class="rte-view"></div>
        </div>
      </article>

      <!-- Etiquetas (solo lectura) -->
      <article class="card" id="sec-tags" aria-label="Sectores y etiquetas">
        <div class="section-hd"><h2>Etiquetas</h2></div>
        <div class="section-bd">
          <div id="active-tags" class="chosen-row" aria-live="polite"></div>
        </div>
      </article>

      <!-- Localización (solo lectura) -->
      <article class="card" id="sec-local" aria-label="Localización de la empresa">
        <div class="section-hd"><h2>Localización</h2></div>
        <div class="section-bd">
          <div class="row row-2">
            <div>
              <div class="label">País</div>
              <div id="country-view">—</div>
            </div>
            <div>
              <div class="label">Provincia / Estado</div>
              <div id="region-view">—</div>
            </div>
          </div>
        </div>
      </article>

      <!-- Proyectos (solo lectura) -->
      <article class="card" id="sec-proyectos" aria-label="Proyectos">
        <div class="section-hd">
          <h2>Proyectos</h2>
          <small id="projCount" class="muted"></small>
        </div>
        <div class="section-bd">
          <div id="proyectos-list" class="row"></div>
        </div>
      </article>

      <!-- Productos (solo lectura) -->
      <article class="card" id="sec-productos" aria-label="Productos">
        <div class="section-hd">
          <h2>Productos</h2>
          <small id="prodCount" class="muted"></small>
        </div>
        <div class="section-bd">
          <div id="productos-list" class="row"></div>
        </div>
      </article>

    </section>
  </main>

  <script>

    // Script para PERFIL-EMPRESA
    (async () => {
      // 1) Carga países y sectores
      const deps = ['/js/countries.js', '/js/sectors.js'];
      for (const src of deps) {
        await new Promise((ok, err) => {
          const s = document.createElement('script');
          s.src = src;
          s.onload = ok;
          s.onerror = err;
          document.head.appendChild(s);
        });
      }

      // 2) Obtener usuario a mostrar → viene en querystring ?user=...
      const qs = new URLSearchParams(location.search);
      const currentUser = qs.get('user');
      if (!currentUser) {
        alert("Falta parámetro ?user en la URL");
        location.href = "/";
        return;
      }

      // 3) Cargar perfil desde backend
      async function loadProfile(email) {
        const res = await fetch(`/api/profiles/${encodeURIComponent(email)}`, { credentials: 'include' });
        if (!res.ok) return null;
        const data = await res.json();
        return data.data || {};
      }

      const current = await loadProfile(currentUser);

      if (!current) {
        alert("Perfil no encontrado");
        return;
      }

      // 4) Helpers (igual que antes)
      function sanitizeHtml(input) {
        const allowedTags = new Set(['P','DIV','SPAN','STRONG','B','EM','I','U','UL','OL','LI','BR','BLOCKQUOTE','H1','H2','H3','H4','H5','H6','A','IMG']);
        const allowedAttrs = new Set(['href','src','alt','title']);
        const tmp = document.createElement('div');
        tmp.innerHTML = String(input || '');

        tmp.querySelectorAll('*').forEach(el => {
          if (!allowedTags.has(el.tagName)) {
            el.replaceWith(...el.childNodes);
            return;
          }
          [...el.attributes].forEach(attr => {
            if (!allowedAttrs.has(attr.name.toLowerCase())) {
              el.removeAttribute(attr.name);
            }
            if (attr.name === 'href' && !/^https?:\/\//i.test(attr.value)) {
              el.removeAttribute('href');
            }
            if (attr.name === 'src' && !/^data:image\/|https?:\/\//i.test(attr.value)) {
              el.removeAttribute('src');
            }
          });
        });

        return tmp.innerHTML;
      }

      function countWordsFromHTML(html) {
        const txt = (html||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
        return txt ? txt.split(' ').length : 0;
      }

      // 5) Renderizar
      const bannerEl = document.getElementById('banner');
      const logoEl = document.getElementById('logo');
      const nameView = document.getElementById('company-name-view');
      const descView = document.getElementById('company-desc-view');
      const wordCountEl = document.getElementById('desc-count');
      const countryView = document.getElementById('country-view');
      const regionView  = document.getElementById('region-view');
      const tagsWrap = document.getElementById('active-tags');
      const proyectosList = document.getElementById('proyectos-list');
      const productosList = document.getElementById('productos-list');
      const projCount = document.getElementById('projCount');
      const prodCount = document.getElementById('prodCount');

      const defaultBanner = '';
      const defaultLogo = '/assets/oneiron.png';

      // Banner y logo
      bannerEl.style.backgroundImage = current.banner ? `url(${current.banner})` : defaultBanner;
      logoEl.src = current.logo || defaultLogo;

      // Nombre
      nameView.textContent = (current.name || '').trim() || 'Empresa sin nombre';

      // Descripción
      descView.innerHTML = sanitizeHtml(current.desc || '<p class="muted">Sin descripción</p>');
      const nWords = countWordsFromHTML(current.desc || '');
      wordCountEl.textContent = `${nWords} / 1000 palabras`;
      wordCountEl.style.color = nWords > 1000 ? 'var(--err)' : 'var(--muted)';

      // Localización
      countryView.textContent = current.country || '—';
      regionView.textContent = current.region || '—';

      // Etiquetas
      tagsWrap.innerHTML = '';
      (Array.isArray(current.tags) ? current.tags : []).forEach(tag => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.textContent = tag;
        tagsWrap.appendChild(chip);
      });
      if (!tagsWrap.children.length) {
        const m = document.createElement('span'); m.className='muted'; m.textContent='Sin etiquetas';
        tagsWrap.appendChild(m);
      }

      // Items: solo mostrar (sin botones de editar/borrar)
      function cardHTML(item){
        const imagesHTML = (item.imagenes && item.imagenes.length)
          ? `<div class="gallery-row">${item.imagenes.map(src=>`<img src="${src}" alt="">`).join('')}</div>`
          : '';
        const htmlDesc = sanitizeHtml(item.descripcion || '');
        return `
          <div class="section-bd">
            <div class="item-head">
              <div class="item-title">${item.titulo || 'Sin título'}</div>
              <small class="muted">${(item.imagenes?.length||0)} foto(s)</small>
            </div>
            ${imagesHTML}
            <div class="item-desc">${htmlDesc}</div>
          </div>
        `;
      }
      function appendCard(listEl, item){
        const card = document.createElement('article');
        card.className = 'card';
        card.style.marginTop = '8px';
        card.innerHTML = cardHTML(item);
        listEl.appendChild(card);
      }
      (current.proyectos||[]).forEach(p => appendCard(proyectosList, p));
      (current.productos||[]).forEach(p => appendCard(productosList, p));
      projCount.textContent = (current.proyectos?.length||0) ? `${current.proyectos.length} elemento(s)` : 'Sin elementos';
      prodCount.textContent = (current.productos?.length||0) ? `${current.productos.length} elemento(s)` : 'Sin elementos';

      if (!(current.proyectos?.length)) proyectosList.innerHTML = '<div class="muted">Sin proyectos</div>';
      if (!(current.productos?.length)) productosList.innerHTML = '<div class="muted">Sin productos</div>';

      console.log("Perfil-empresa renderizado:", currentUser);
    })().catch(console.error);

  </script>

</body>
</html>
