<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="/assets/oneiron.ico" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ONEIRON ‚Äî Perfil de empresa</title>
  <style>
    :root{
      /* Paleta coherente con index.html */
      --bg:#f7f9fc; --card:#ffffffee; --glass:#ffffffb8; --soft:#f3f6fb80; --stroke:#d1d9e680; --text:#0f172a; --muted:#6b7280;
      --radius:16px; --shadow-xl:0 10px 30px rgba(20,24,60,.12), 0 2px 8px rgba(20,24,60,.08); --ring:0 0 0 6px rgba(79,70,229,.18);
      --ok:#16a34a; --err:#ef4444;
      --sidebar-w: 260px; --gap: 18px; 
      --banner-h: clamp(160px, 20vh, 360px);

      /* Colores clave (como en index) */
      --indigo-bright:#6366f1;      /* CTA claro/brillante */
      --indigo-bright-2:#818cf8;
      --sky:#38bdf8;                /* bot√≥n Etiquetas */
      --sky-2:#7dd3fc;

      /* Banner igual que index */
      --banner-start:#c7d2fe; 
      --banner-end:#a5b4fc;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:var(--bg); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; overflow-x:hidden;
    }

    /* fondo on√≠rico */
    .dream-bg{ position:fixed; inset:0; z-index:-3; overflow:hidden;
      background:
        radial-gradient(1200px 520px at 50% -5%, rgba(79,70,229,.22), transparent 60%),
        radial-gradient(900px 380px at 15% 100%, rgba(37,99,235,.22), transparent 60%),
        radial-gradient(700px 300px at 85% 90%, rgba(56,189,248,.18), transparent 60%),
        linear-gradient(#f9fbff, #f1f5ff 60%, #f7f9fc);
    }
    .stars,.grain{position:absolute; inset:0; pointer-events:none}
    .stars{ background-image:
      radial-gradient(1px 1px at 10% 20%, rgba(38,38,80,.6) 40%, transparent 41%),
      radial-gradient(1px 1px at 30% 70%, rgba(38,38,80,.5) 40%, transparent 41%),
      radial-gradient(1px 1px at 60% 30%, rgba(38,38,80,.55) 40%, transparent 41%),
      radial-gradient(1.2px 1.2px at 80% 60%, rgba(38,38,80,.45) 40%, transparent 41%),
      radial-gradient(0.9px 0.9px at 50% 85%, rgba(38,38,80,.45) 40%, transparent 41%); filter:blur(.2px); opacity:.55; }
    .grain{ mix-blend-mode:soft-light; opacity:.35;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="160" height="160" filter="url(%23n)" opacity="0.08"/></svg>');
      background-size:160px 160px; }
    .orb{position:absolute; filter:blur(24px); opacity:.35; border-radius:999px; will-change:transform;}
    .orb.one{width:380px; height:380px; left:-80px; top:10vh; background:radial-gradient(circle at 30% 30%, #93c5fd, transparent 60%)}
    .orb.two{width:420px; height:420px; right:-120px; top:45vh; background:radial-gradient(circle at 70% 40%, #a5b4fc, transparent 60%)}
    .orb.three{width:300px; height:300px; left:55vw; top:-120px; background:radial-gradient(circle at 30% 70%, #67e8f9, transparent 60%)}
    @keyframes drift{0%{transform:translate3d(0,0,0) rotate(0)}50%{transform:translate3d(0,12px,0) rotate(1deg)}100%{transform:translate3d(0,0,0) rotate(0)}}
    .orb{animation:drift 11s ease-in-out infinite}

    /* Layout general */
    .layout{ margin:0; padding:0 22px 80px; }

    /* Sidebar / √çndice (plano) */
    .sidebar{
      position:fixed;
      top: var(--banner-h);
      left:0;
      width:var(--sidebar-w);
      height: calc(100vh - var(--banner-h));
      overflow:auto; scrollbar-gutter:stable;
      border:1px solid var(--stroke); border-left:0; border-radius:0 20px 20px 0;
      background:linear-gradient(180deg, var(--card), var(--soft)); box-shadow:var(--shadow-xl); padding:12px; z-index:9;
    }
    .side-title{ font-size:.85rem; color:var(--muted); margin:6px 8px; text-transform:uppercase; letter-spacing:.06em }
    .side-nav{ display:grid; gap:10px; }
    .side-nav a,
    .side-nav .btn-link{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; text-decoration:none; color:var(--text);
      border:1px solid var(--stroke); background:#fff; position:relative; justify-content:flex-start;
    }
    .side-nav a .left{display:flex; align-items:center; gap:8px}
    .side-nav a .icon{ width:18px; height:18px; opacity:.9 }
    .side-nav a:hover{ box-shadow:0 10px 18px rgba(79,70,229,.12) }
    .side-nav a.active{ outline:2px solid color-mix(in oklab, var(--indigo-bright) 35%, white 65%); background:linear-gradient(180deg, #fff, #f8fafc) }
    .side-nav .btn-primary{
      background:linear-gradient(135deg, var(--indigo-bright), var(--indigo-bright-2));
      color:#fff; border-color:transparent; font-weight:700; justify-content:center;
      box-shadow:0 10px 24px rgba(99,102,241,.25);
    }
    .side-nav .btn-primary:hover{ filter:brightness(1.05) saturate(1.02); }

    /* Panel de contenido */
    .panel{
      display:grid; gap:16px;
      margin-left: calc(var(--sidebar-w) + var(--gap));
      margin-top: var(--banner-h);
      max-width: none;
      margin-right: 22px;
    }

    .card{ border:1px solid var(--stroke); background:linear-gradient(180deg, var(--card), var(--soft)); border-radius:20px; box-shadow:var(--shadow-xl); overflow:hidden; }
    .section-hd{ display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--stroke); }
    .section-hd h2{ margin:0; font-size:1.05rem; letter-spacing:.2px }
    .section-bd{ padding:14px; }

    /* Banner fijo arriba: MISMO color que index */
    /*
    #sec-banner{ height:0; margin:0; }
    #sec-banner .section-bd{ padding:0; height:0; }
    #sec-banner .card{ background:transparent; border:0; box-shadow:none; }
    */
    .banner-wrap{
      position:fixed; top:0; left:0; width:100vw; height:var(--banner-h);
      background:linear-gradient(135deg, var(--banner-start), var(--banner-end)); /* <- igual que index */
      border-radius:0; display:grid; place-items:center; z-index:8;
    }
    .banner{ position:absolute; inset:0; background-size:cover; background-position:center; filter:saturate(1) contrast(1); }
    .banner-overlay{ position:absolute; inset:0; background:radial-gradient(800px 260px at 50% 0%, rgba(255,255,255,.18), transparent 60%), linear-gradient(to bottom, rgba(255,255,255,.15), rgba(255,255,255,.02)); pointer-events:none }
    .logo-on-banner{ position:absolute; inset:0; display:grid; place-items:center; transform: translateY(18px); }
    .logo-on-banner img{ width:calc(var(--banner-h) * 0.46); height:calc(var(--banner-h) * 0.46); object-fit:contain; border-radius:24px; background:#fff; padding:12px; box-shadow:0 12px 30px rgba(15,23,42,.22) }

    .banner-hint {
      position: absolute;
      top: 10px;
      right: 24px;
      font-size: 0.9rem;
      color: var(--muted);
      background: rgba(255,255,255,0.7);
      padding: 4px 8px;
      border-radius: 8px;
    }

    .uploader { position: absolute; right: 24px; bottom: 14px; display:flex; gap:12px; }
    /* Botones Banner/Logo -> color CTA de index */
    .upl { border:1px solid var(--stroke); background:linear-gradient(135deg, var(--indigo-bright), var(--indigo-bright-2)); color:#fff; padding:10px 14px; border-radius:14px; cursor:pointer; display:flex; align-items:center; gap:8px; font-weight:700; box-shadow:0 10px 24px rgba(99,102,241,.25); transition: box-shadow .2s, transform .2s; }
    .upl:hover { filter:brightness(1.05) saturate(1.02); transform:translateY(-1px); }
    .upl input{ display:none; }
    #reset-media.upl { background:#fff; color:var(--text); border:1px solid var(--stroke); box-shadow:0 8px 18px rgba(15,23,42,.10); }
    #reset-media.upl:hover { transform:none; filter:none; }

    .row{ display:grid; gap:10px; margin:10px 0 }
    .label{ font-size:.92rem; color:var(--muted) }
    .input, select, textarea, button{ border:1px solid var(--stroke); background:linear-gradient(180deg, #fff, #f8fafc); color:var(--text); padding:12px 14px; border-radius:var(--radius); outline:none; transition:border-color .15s, box-shadow .2s; box-shadow:0 1px 0 rgba(0,0,0,.02) inset, 0 6px 14px rgba(15,23,42,.06); }
    .input:focus-visible, select:focus-visible, textarea:focus-visible, button:focus-visible{ border-color:var(--indigo-bright); box-shadow:var(--ring) }

    /* RTE (editor enriquecido) */
    .rte{ display:grid; gap:8px }
    .rte-toolbar{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      border:1px solid var(--stroke); background:linear-gradient(180deg, #fff, #f8fafc); border-radius:12px; padding:6px 8px;
    }
    .rte-toolbar .seg{ display:flex; gap:6px; align-items:center }
    .rte-toolbar select, .rte-toolbar input[type="color"], .rte-toolbar button{
      height:34px; padding:6px 10px; border-radius:10px; border:1px solid var(--stroke); background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.02) inset;
    }
    .rte-toolbar button{ cursor:pointer }
    .rte-toolbar button.active{ background:#0f172a; color:#fff; }
    .rte-editor{
      min-height:140px; padding:12px 14px; border:1px solid var(--stroke); background:linear-gradient(180deg, #fff, #f8fafc); border-radius:12px; outline:none;
    }
    .rte-editor:focus{ border-color:var(--indigo-bright); box-shadow:var(--ring) }
    .rte-note{ font-size:.85rem; color:var(--muted) }

    .toolbar{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }

    /* Bot√≥n Etiquetas -> igual que index */
    .tags-btn{
      display:inline-flex; align-items:center; gap:8px; cursor:pointer; user-select:none; height:42px;
      background:linear-gradient(135deg, var(--sky), var(--sky-2));
      color:#fff; border:1px solid color-mix(in oklab, var(--sky) 40%, #ffffff 60%);
      box-shadow:0 8px 20px rgba(56,189,248,.3); border-radius:12px; padding:10px 12px;
    }

    .chosen-row{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--stroke); background:linear-gradient(180deg, #fff, #f8fafc); padding:6px 10px; border-radius:999px; font-size:.9rem; }
    .chip .x{ border:0; background:transparent; padding:2px; cursor:pointer; line-height:0; display:grid; place-items:center; }

    .row-2{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px }

    .actions-row{ display:flex; justify-content:flex-end; gap:10px; margin-top:6px }
    /* Botones principales (A√±adir proyectos / productos) -> color CTA de index */
    .btn{ border:1px solid var(--stroke); background:linear-gradient(135deg, var(--indigo-bright), var(--indigo-bright-2)); color:#fff; padding:12px 16px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:0 10px 24px rgba(99,102,241,.25) }
    .ghost{ background:#fff; color:#000; font-weight:600 }
    .danger{ background:linear-gradient(135deg, #ef4444, #dc2626); border-color:#ef4444; }

    /* Guardar cambios => blanco */
    #save-profile.btn{ background:#fff; color:#000; border:1px solid var(--stroke); box-shadow:0 8px 18px rgba(15,23,42,.10) }

    /* Drawer etiquetas */
    .drawer-overlay{ position:fixed; inset:0; background:radial-gradient(1200px 700px at 20% 50%, rgba(79,70,229,.12), transparent 60%), rgba(2,6,23,.28);
      backdrop-filter: blur(3px); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:20; }
    .drawer{ position:fixed; top:0; left:0; height:100dvh; width:clamp(320px, 33.33vw, 520px); transform:translateX(-102%);
      transition: transform .32s cubic-bezier(.2,.8,.2,1); z-index:21; display:flex; flex-direction:column;
      border-right:1px solid var(--stroke); background:linear-gradient(180deg, var(--card), var(--soft)); box-shadow:var(--shadow-xl); }
    .drawer.open{ transform:translateX(0); }
    .drawer-overlay.open{ opacity:1; pointer-events:auto; }
    .drawer .hd{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; position:relative; }
    .drawer .hd h2{ font-size:1.05rem; margin:0; letter-spacing:.3px; }
    .drawer .close{ border:1px solid var(--stroke); background:var(--card); border-radius:12px; padding:8px; cursor:pointer; }
    .drawer .content{ padding:12px 12px 18px 12px; overflow:auto; scrollbar-gutter:stable; }
    .picker{ display:grid; grid-template-columns:1fr; gap:12px; }
    .picker label{ display:grid; gap:6px; font-size:.9rem; color:var(--muted); }
    .picker .actions{ display:flex; gap:8px; align-items:center; }
    .picker .add{ background:linear-gradient(135deg, var(--indigo-bright), var(--indigo-bright-2)); color:#fff; border:0; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:0 8px 20px rgba(79,70,229,.22); }
    .drawer .ft{ margin:8px 0 12px; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:0 12px; }
    .ft .summary{ font-size:.9rem; color:var(--muted); }
    .clear{ border:1px solid var(--stroke); background:#fff; border-radius:12px; padding:10px 12px; cursor:pointer; }

    /* Modales y confirmaci√≥n */
    .modal{ position:fixed; inset:0; z-index:9999; display:none; align-items:center; justify-content:center; }
    .modal.open{ display:flex; }
    .modal::before{ content:""; position:absolute; inset:0; background:radial-gradient(1200px 700px at 20% 50%, rgba(79,70,229,.12), transparent 60%), rgba(2,6,23,.45); backdrop-filter: blur(2px); }
    .modal-card{ position:relative; width:min(720px, calc(100vw - 40px)); border:1px solid var(--stroke); background:linear-gradient(180deg, var(--card), var(--soft)); border-radius:20px; box-shadow:var(--shadow-xl); overflow:hidden; z-index:1; }
    .modal-card .section-hd{ padding:12px 16px; }
    .modal-card .section-bd{ padding:14px 16px; }
    .modal-close{ border:1px solid var(--stroke); background:#fff; border-radius:12px; padding:8px; cursor:pointer; }

    /* Tarjetas de items */
    .item-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
    .item-title{ font-weight:700; font-size:1rem; }
    .delete-btn{
      border:1px solid #fecaca; background:#fee2e2; color:#b91c1c;
      padding:6px; border-radius:10px; cursor:pointer; display:inline-grid; place-items:center;
      transition:transform .08s ease, box-shadow .2s ease;
    }
    .delete-btn:hover{ box-shadow:0 6px 16px rgba(239,68,68,.25); }
    .delete-btn:active{ transform: translateY(1px); }

    .gallery-row{ display:flex; gap:8px; flex-wrap:wrap; margin:6px 0 8px; }
    .gallery-row img{ height:110px; width:auto; object-fit:cover; border-radius:12px; border:1px solid var(--stroke); background:#fff; }

    /* Bot√≥n quitar sobre im√°genes */
    .thumb{
      position:relative; display:inline-block;
    }
    .thumb img{ display:block; }
    .thumb .rm{
      position:absolute; top:6px; right:6px;
      border:1px solid #fecaca; background:#fee2e2; color:#b91c1c;
      border-radius:999px; width:26px; height:26px; display:grid; place-items:center;
      cursor:pointer; box-shadow:0 4px 10px rgba(239,68,68,.25);
    }
    .thumb .rm svg{ width:14px; height:14px; }

    .item-desc{ color:var(--muted); margin:.35rem 0 0; }
    .item-desc a{ color:#2563eb; text-decoration:none; }
    .item-desc a:hover{ text-decoration:underline; }

    @media (prefers-reduced-motion: reduce){ .orb{animation:none} }
  </style>
</head>
<body>
  <div class="dream-bg" aria-hidden="true">
    <div class="orb one"></div>
    <div class="orb two"></div>
    <div class="orb three"></div>
    <div class="stars"></div>
    <div class="grain"></div>
  </div>

  <!-- Drawer etiquetas -->
  <div id="drawer-overlay" class="drawer-overlay" aria-hidden="true"></div>
  <aside id="tags-drawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="drawer-title" aria-hidden="true">
    <div class="hd">
      <h2 id="drawer-title">Etiquetas por sector</h2>
      <button class="close" id="drawer-close" aria-label="Cerrar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="content">
      <div class="picker" aria-label="Selector de etiquetas">
        <label>Sector
          <select id="sector-select">
            <option value="" selected disabled>elige un sector‚Ä¶</option>
          </select>
        </label>
        <label>Subsector
          <select id="subsector-select" disabled>
            <option value="" selected>elige un subsector‚Ä¶</option>
          </select>
        </label>
        <div class="actions">
          <button id="add-chip" class="add" type="button">A√±adir etiqueta</button>
          <button id="drawer-clear" class="clear" type="button">Limpiar seleccionadas</button>
        </div>
      </div>
    </div>
    <div class="ft">
      <span class="summary" id="drawer-summary">0 etiquetas seleccionadas</span>
    </div>
  </aside>

  <!-- √çndice lateral (plano) + bot√≥n Inicio -->
  <aside class="sidebar" aria-label="√çndice de edici√≥n">
    <div class="side-title">Navegaci√≥n</div>
    <nav class="side-nav" id="side-nav">
      <a class="btn-link btn-primary" href="/templates/index.html" title="Volver al inicio">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l9-9 9 9"/><path d="M9 21V9h6v12"/></svg>
          Inicio
        </span>
      </a>

      <a href="#sec-nombre">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
          Nombre
        </span>
      </a>

      <a href="#sec-desc">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v16H4z"/><path d="M8 8h8M8 12h8M8 16h6"/></svg>
          Descripci√≥n
        </span>
      </a>

      <a href="#sec-tags">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 10l-8 8-8-8 8-8 8 8z"/></svg>
          Etiquetas
        </span>
      </a>

      <a href="#sec-local">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 21s-6-4.35-6-10a6 6 0 1112 0c0 5.65-6 10-6 10z"/><circle cx="12" cy="11" r="2"/></svg>
          Localizaci√≥n
        </span>
      </a>

      <a href="#sec-proyectos">
        <span class="left">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="14"/><path d="M3 17l4 4h10l4-4"/></svg>
          Proyectos
        </span>
      </a>

      <a href="#sec-productos">
        <span class="left">
          <!-- Caja/paquete -->
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M21 8l-9-4-9 4v8l9 4 9-4V8z"/>
            <path d="M12 12V4M3 8l9 4 9-4"/>
          </svg>
          Productos
        </span>
      </a>
    </nav>
  </aside>

  <main class="layout">
    <section class="panel">

      <!-- Banner fijo arriba -->
      <div class="banner-wrap" id="banner-wrap">
        <div class="banner" id="banner" role="img" aria-label="Imagen de cabecera"></div>
        <div class="banner-overlay"></div>
        <div class="logo-on-banner">
          <img id="logo" alt="Logotipo" src="/assets/oneiron.png">
        </div>
        <div class="banner-hint" id="banner-hint">1920√ó216 recomendado</div>
        <div class="uploader">
          <label class="upl" aria-label="Subir imagen de banner" title="Se recomienda 1920√ó216 px (formato horizontal)">
            <input id="banner-input" type="file" accept="image/*">Banner
          </label>
          <label class="upl" aria-label="Subir logotipo">
            <input id="logo-input" type="file" accept="image/*">Logo
          </label>
          <button class="upl" type="button" id="reset-media" title="Restablecer im√°genes">Restablecer</button>
        </div>
      </div>

      <!-- Nombre -->
      <article class="card" id="sec-nombre" aria-label="Nombre de la empresa">
        <div class="section-hd"><h2>Nombre</h2></div>
        <div class="section-bd">
          <div class="row">
            <label class="label" for="company-name">Nombre de la empresa</label>
            <input class="input" id="company-name" type="text" placeholder="Introduce el nombre" maxlength="140"/>
          </div>
        </div>
      </article>

      <!-- Descripci√≥n -->
      <article class="card" id="sec-desc" aria-label="Descripci√≥n de la empresa">
        <div class="section-hd">
          <h2>Descripci√≥n</h2>
          <small id="desc-count" style="color:var(--muted)">0 / 1000 palabras</small>
        </div>
        <div class="section-bd">
          <div class="row rte" data-editor="company-desc">
            <div class="rte-toolbar" id="toolbar-company-desc"></div>
            <div id="company-desc" class="rte-editor" contenteditable="true" data-allow-links="true" aria-label="Descripci√≥n (editor enriquecido)"></div>
            <div class="rte-note">Puedes dar formato (fuente, tama√±o (sistema Word), color) y pegar enlaces http:// o https://</div>
          </div>
        </div>
      </article>

      <!-- Etiquetas -->
      <article class="card" id="sec-tags" aria-label="Sectores y etiquetas">
        <div class="section-hd">
          <h2>Etiquetas</h2>
          <button id="add-tags" type="button" class="tags-btn" title="A√±adir etiquetas" aria-expanded="false" aria-controls="tags-drawer">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            <span id="tags-label">etiquetas</span>
          </button>
        </div>
        <div class="section-bd">
          <div id="active-tags" class="chosen-row" aria-live="polite"></div>
        </div>
      </article>

      <!-- Localizaci√≥n -->
      <article class="card" id="sec-local" aria-label="Localizaci√≥n de la empresa">
        <div class="section-hd"><h2>Localizaci√≥n</h2></div>
        <div class="section-bd">
          <div class="row row-2">
            <label class="label" aria-label="Seleccionar pa√≠s">Pa√≠s
              <select id="country"><option value="" selected disabled>pa√≠s</option></select>
            </label>
            <label class="label" aria-label="Seleccionar provincia o estado">Provincia / Estado
              <select id="region" disabled><option value="" selected>provincia / estado</option></select>
            </label>
          </div>
        </div>
      </article>

      <!-- Proyectos -->
      <article class="card" id="sec-proyectos" aria-label="Proyectos">
        <div class="section-hd">
          <h2>Proyectos</h2>
          <button class="btn" id="open-proyecto">A√±adir proyectos</button>
        </div>
        <div class="section-bd">
          <div id="proyectos-list" class="row"></div>
        </div>
      </article>

      <!-- Productos -->
      <article class="card" id="sec-productos" aria-label="Productos">
        <div class="section-hd">
          <h2>Productos</h2>
          <button class="btn" id="open-producto">A√±adir productos</button>
        </div>
        <div class="section-bd">
          <div id="productos-list" class="row"></div>
        </div>
      </article>

      <div class="actions-row">
        <button class="btn" id="save-profile" type="button">Guardar cambios</button>
      </div>
    </section>
  </main>

  <!-- Modales -->
  <div class="modal" id="modal-proyecto" aria-hidden="true">
    <div class="modal-card">
      <div class="section-hd">
        <h2>Nuevo proyecto</h2>
        <button class="modal-close" data-close="#modal-proyecto" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="section-bd">
        <div class="row">
          <label class="label" for="proy-nombre">Nombre del proyecto</label>
          <input class="input" id="proy-nombre" type="text" maxlength="200" placeholder="Nombre del proyecto">
          <label class="label">Descripci√≥n (con formato)</label>
          <div class="rte" data-editor="proy-desc">
            <div class="rte-toolbar" id="toolbar-proy-desc"></div>
            <div id="proy-desc" class="rte-editor" contenteditable="true"></div>
          </div>
          <label class="label" for="proy-fotos">Fotos del proyecto</label>
          <input id="proy-fotos" type="file" accept="image/*" multiple>
          <div id="proy-fotos-preview" class="gallery-row" aria-live="polite"></div>
          <div class="actions-row">
            <button class="btn ghost" data-close="#modal-proyecto">Cancelar</button>
            <button class="btn" id="save-proyecto">Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-producto" aria-hidden="true">
    <div class="modal-card">
      <div class="section-hd">
        <h2>Nuevo producto</h2>
        <button class="modal-close" data-close="#modal-producto" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="section-bd">
        <div class="row">
          <label class="label" for="prod-nombre">Nombre del producto</label>
          <input class="input" id="prod-nombre" type="text" maxlength="200" placeholder="Nombre del producto">
          <label class="label">Descripci√≥n (con formato)</label>
          <div class="rte" data-editor="prod-desc">
            <div class="rte-toolbar" id="toolbar-prod-desc"></div>
            <div id="prod-desc" class="rte-editor" contenteditable="true"></div>
          </div>
          <label class="label" for="prod-fotos">Fotos del producto</label>
          <input id="prod-fotos" type="file" accept="image/*" multiple>
          <div id="prod-fotos-preview" class="gallery-row" aria-live="polite"></div>
          <div class="actions-row">
            <button class="btn ghost" data-close="#modal-producto">Cancelar</button>
            <button class="btn" id="save-producto">Guardar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n de borrado -->
  <div class="modal" id="confirm-modal" aria-hidden="true">
    <div class="modal-card" role="alertdialog" aria-labelledby="confirm-title" aria-describedby="confirm-desc">
      <div class="section-hd">
        <h2 id="confirm-title">Confirmar borrado</h2>
        <button class="modal-close" data-close="#confirm-modal" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="section-bd">
        <p id="confirm-desc" style="color:var(--muted); margin-top:0">¬øSeguro que quieres borrar este elemento? Esta acci√≥n no se puede deshacer.</p>
        <div class="actions-row">
          <button class="btn ghost" data-close="#confirm-modal">Cancelar</button>
          <button class="btn danger" id="confirm-yes">S√≠, borrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    
  </script>

  <script src="/js/supabase.js"></script>
  <script>

    // Espera a que cargue dependencias
    (async () => {
      // 1) Carga pa√≠ses y sectores (igual que antes)
      const deps = ['/js/countries.js', '/js/sectors.js'];
      for (const src of deps) {
        await new Promise((ok, err) => {
          const s = document.createElement('script');
          s.src = src;
          s.onload = ok;
          s.onerror = err;
          document.head.appendChild(s);
        });
      }

      // 2) Obt√©n usuario autenticado
      const meRes = await fetch('/api/me', { credentials: 'include' });
      const me = meRes.ok ? await meRes.json() : null;
      const currentUser = (me && me.email) ? me.email : null;

      if (!currentUser) {
        alert("Debes iniciar sesi√≥n para ver tu perfil.");
        location.href = "/templates/login.html";
        return;
      }

      // 3) Carga perfil desde backend
      async function loadProfile() {
        const res = await fetch(`/api/profiles/${currentUser}`, { credentials: 'include' });
        if (!res.ok) return { name:'', desc:'', tags:[], country:'', region:'', banner:'', logo:'', proyectos:[], productos:[] };
        const data = await res.json();
        return data.data || {};
      }

      // 4) Guarda perfil en backend
      async function saveProfile(profile) {
        const res = await fetch(`/api/profiles/${currentUser}`, {
          method: 'PUT',
          headers: { 'Content-Type':'application/json' },
          credentials: 'include',
          body: JSON.stringify({ data: profile })
        });
        if (!res.ok) {
          const txt = await res.text();
          throw new Error("Error guardando perfil: " + txt);
        }
      }

      // 5) Estado inicial
      let current = await loadProfile();

      // 6) Aqu√≠ pega exactamente tu l√≥gica de UI
      /* ========= Persistencia ========= */
        const defaultBanner = ''; // usamos gradiente del contenedor
        const defaultLogo = './assets/oneiron.png';

        /* ========= UI Refs ========= */
        const bannerEl = document.getElementById('banner');
        const logoEl = document.getElementById('logo');
        const bannerInput = document.getElementById('banner-input');
        const bannerHint = document.getElementById('banner-hint');
        const logoInput = document.getElementById('logo-input');
        const resetMediaBtn = document.getElementById('reset-media');
        const nameInput = document.getElementById('company-name');
        const descEditor = document.getElementById('company-desc');
        const wordCountEl = document.getElementById('desc-count');
        const saveBtn = document.getElementById('save-profile');

        /* ========= Pa√≠ses y regiones ========= */
        const country = document.getElementById('country');
        const region = document.getElementById('region');

        if (window.countryData){
          Object.keys(window.countryData).sort().forEach(p=>{
            const opt=document.createElement('option'); opt.value=p; opt.textContent=p; country.appendChild(opt);
          });
        }
        country.addEventListener('change', ()=>{
          const sel=country.value;
          region.innerHTML='<option value="" selected>provincia / estado</option>';
          if(!sel){ region.disabled=true; return; }
          window.countryData[sel].forEach(r=>{
            const o=document.createElement('option'); o.value=r; o.textContent=r; region.appendChild(o);
          });
          region.disabled=false;
        });

        /* ========= Drawer de etiquetas ========= */
        const drawer = document.getElementById('tags-drawer');
        const overlay = document.getElementById('drawer-overlay');
        const tagsBtn = document.getElementById('add-tags');
        const drawerClose = document.getElementById('drawer-close');
        const drawerSummary = document.getElementById('drawer-summary');
        const tagsLabel = document.getElementById('tags-label');
        const activeTags = document.getElementById('active-tags');

        const sectorSelect = document.getElementById('sector-select');
        const subSelect = document.getElementById('subsector-select');
        const addChipBtn = document.getElementById('add-chip');
        const clearBtn = document.getElementById('drawer-clear');

        const sectors = (window.sectorData && typeof window.sectorData === 'object' && Object.keys(window.sectorData).length) ? window.sectorData : {};

        const selected = new Set();

        function populateSectors(){
          sectorSelect.innerHTML = '<option value="" selected disabled>elige un sector‚Ä¶</option>';
          Object.keys(sectors).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; sectorSelect.appendChild(o); });
          subSelect.innerHTML = '<option value="" selected>elige un subsector‚Ä¶</option>'; subSelect.disabled = true;
        }
        populateSectors();

        sectorSelect.addEventListener('change', ()=>{
          const s=sectorSelect.value;
          subSelect.innerHTML='<option value="" selected>elige un subsector‚Ä¶</option>';
          if(!s){ subSelect.disabled=true; return; }
          (sectors[s]||[]).forEach(sub=>{
            const o=document.createElement('option'); o.value=sub; o.textContent=sub; subSelect.appendChild(o);
          });
          subSelect.disabled=false; subSelect.focus();
        });

        function renderActiveTags(){
          activeTags.innerHTML='';
          selected.forEach(tag=>{
            const chip=document.createElement('span');
            chip.className='chip';
            chip.innerHTML=`${tag} <button class="x" aria-label="Quitar ${tag}" data-tag="${tag}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>`;
            activeTags.appendChild(chip);
          });
        }
        function updateSummary(){
          const n=selected.size;
          drawerSummary.textContent=`${n} etiqueta${n!==1?'s':''} seleccionada${n!==1?'s':''}`;
          tagsLabel.textContent = n ? `etiquetas (${n})` : 'etiquetas';
        }
        function addCurrentSelection(){
          const sector=sectorSelect.value; const sub=subSelect.value;
          if(!sector||!sub) return;
          const label=`${sector}: ${sub}`;
          if(!selected.has(label)){ selected.add(label); renderActiveTags(); updateSummary(); }
        }

        addChipBtn.addEventListener('click', addCurrentSelection);
        activeTags.addEventListener('click', (e)=>{
          const btn=e.target.closest('button.x'); if(!btn) return;
          const tag=btn.getAttribute('data-tag'); selected.delete(tag); renderActiveTags(); updateSummary();
        });
        clearBtn.addEventListener('click', ()=>{ selected.clear(); renderActiveTags(); updateSummary(); });

        function openDrawer(){
          drawer.classList.add('open'); overlay.classList.add('open');
          drawer.removeAttribute('aria-hidden'); overlay.removeAttribute('aria-hidden');
          tagsBtn.setAttribute('aria-expanded','true'); setTimeout(()=>{ sectorSelect.focus(); }, 60);
        }
        function closeDrawer(){
          drawer.classList.remove('open'); overlay.classList.remove('open');
          drawer.setAttribute('aria-hidden','true'); overlay.setAttribute('aria-hidden','true');
          tagsBtn.setAttribute('aria-expanded','false'); tagsBtn.focus();
        }
        if (tagsBtn) tagsBtn.addEventListener('click', ()=>{ openDrawer(); });
        if (drawerClose) drawerClose.addEventListener('click', closeDrawer);
        if (overlay) overlay.addEventListener('click', closeDrawer);
        window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && drawer.classList.contains('open')) closeDrawer(); if(e.key==='Enter' && drawer.classList.contains('open')) addCurrentSelection(); });

        /* ========= Im√°genes ========= */
        function readImage(file, cb){ const r=new FileReader(); r.onload=e=>cb(e.target.result); r.readAsDataURL(file); }

        // === Helpers para redimensionar/comprimir el banner ===
        async function readFileAsImage(file){
          const dataUrl = await new Promise(res => {
            const r = new FileReader();
            r.onload = e => res(e.target.result);
            r.readAsDataURL(file);
          });
          const img = await new Promise(res => {
            const i = new Image();
            i.onload = () => res(i);
            i.src = dataUrl;
          });
          return img;
        }

        // "cover" centrado a 1920x216 y exportado a JPEG ~0.82
        async function makeBannerDataURL(file, targetW=1920, targetH=216, quality=0.82){
          const img = await readFileAsImage(file);
          const canvas = document.createElement('canvas');
          canvas.width = targetW;
          canvas.height = targetH;
          const ctx = canvas.getContext('2d');

          const scale = Math.max(targetW / img.width, targetH / img.height);
          const drawW = img.width * scale;
          const drawH = img.height * scale;
          const dx = (targetW - drawW) / 2;
          const dy = (targetH - drawH) / 2;

          ctx.imageSmoothingQuality = 'high';
          ctx.drawImage(img, dx, dy, drawW, drawH);

          return canvas.toDataURL('image/jpeg', quality);
        }

        bannerInput.addEventListener('change', async ()=>{
          const f = bannerInput.files?.[0];
          if(!f) return;
          try{
            // 1920x216 encaja perfecto con --banner-h: 220px (2x para HiDPI)
            const data = await makeBannerDataURL(f, 1920, 216, 0.82);
            bannerEl.style.backgroundImage = `url(${data})`;
            current.banner = data; // mucho m√°s ligero -> no rompe la cuota
            bannerHint.style.display = 'none'; // üëà oculta el hint
          }catch(e){
            alert('No se pudo procesar la imagen del banner.');
          }
        });
        logoInput.addEventListener('change', ()=>{ const f=logoInput.files?.[0]; if(!f) return; readImage(f, (data)=>{ logoEl.src = data; current.logo = data; }); });
        resetMediaBtn.addEventListener('click', ()=>{ bannerEl.style.backgroundImage = defaultBanner; logoEl.src = defaultLogo; current.banner=''; current.logo=''; bannerHint.style.display = ''; });

        /* ========= Editor enriquecido ========= */

        // Forzamos inline CSS para comandos (mejor consistencia entre navegadores)
        try{ document.execCommand('styleWithCSS', false, true); }catch(e){}

        // Guardamos la √∫ltima selecci√≥n v√°lida de cada editor
        const lastSelectionMap = new WeakMap();

        function isOrContains(parent, node){
          while(node){
            if(node === parent) return true;
            node = node.parentNode;
          }
          return false;
        }

        function placeCaretAtEnd(editor){
          editor.focus({preventScroll:true});
          const sel = window.getSelection();
          const range = document.createRange();
          if(!editor.firstChild){
            editor.appendChild(document.createTextNode('')); // garantiza un nodo donde colapsar
          }
          range.selectNodeContents(editor);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        }

        function saveSelection(editor){
          const sel = window.getSelection();
          if(!sel || sel.rangeCount === 0) return;
          const range = sel.getRangeAt(0);
          if(isOrContains(editor, range.startContainer) && isOrContains(editor, range.endContainer)){
            lastSelectionMap.set(editor, range.cloneRange());
          }
        }

        function ensureSelectionInEditor(editor){
          const sel = window.getSelection();
          if(!sel || sel.rangeCount===0 || !isOrContains(editor, sel.anchorNode)){
            placeCaretAtEnd(editor);
          }
        }

        function restoreSelection(editor){
          const sel = window.getSelection();
          const range = lastSelectionMap.get(editor);
          editor.focus({preventScroll:true});
          sel.removeAllRanges();
          if(range){
            sel.addRange(range);
          }else{
            placeCaretAtEnd(editor);
          }
        }

        function getRangeHTML(range){
          const frag = range.cloneContents();
          const div = document.createElement('div');
          div.appendChild(frag);
          return div.innerHTML;
        }

        function applyInlineStyle(editor, cssProp, cssValue){
          ensureSelectionInEditor(editor);
          const selection = window.getSelection();
          if(!selection || selection.rangeCount === 0) return;
          const range = selection.getRangeAt(0);

          if(range.collapsed){
            // Inserta un span con estilo y un caracter invisible para continuar escribiendo con ese estilo
            const span = document.createElement('span');
            span.style[cssProp] = cssValue;
            span.appendChild(document.createTextNode('\u200B'));
            range.insertNode(span);
            // Mueve el caret dentro del span
            const r = document.createRange();
            r.setStart(span.firstChild, 1);
            r.collapse(true);
            selection.removeAllRanges();
            selection.addRange(r);
            // Limpia el caracter invisible en cuanto el usuario teclee algo
            const cleanup = () => {
              span.textContent = span.textContent.replace('\u200B', '');
              editor.removeEventListener('input', cleanup);
            };
            editor.addEventListener('input', cleanup);
          }else{
            const html = getRangeHTML(range);
            const wrapper = `<span style="${cssProp}: ${cssValue}">${html}</span>`;
            document.execCommand('insertHTML', false, wrapper);
          }
          saveSelection(editor);
        }

        function updateToolbarStates(editor, toolbar){
          const map = { bold:'bold', italic:'italic', underline:'underline' };
          Object.keys(map).forEach(key=>{
            const btn = toolbar.querySelector(`button[data-cmd="${key}"]`);
            if(!btn) return;
            let active = false;
            try{ active = document.queryCommandState(map[key]); }catch(e){}
            btn.classList.toggle('active', !!active);
            btn.setAttribute('aria-pressed', active ? 'true' : 'false');
          });
        }

        function makeToolbar(targetId, toolbarId){
          const tb = document.getElementById(toolbarId);
          const editor = document.getElementById(targetId);

          // Opciones de tama√±o al estilo Word (sin 72)
          const wordSizes = [8,9,10,11,12,14,16,18,20,24,28,36,48];

          tb.innerHTML = `
            <div class="seg">
              <select data-cmd="fontName" aria-label="Fuente">
                <option value="" selected>Fuente</option>
                <option>Inter</option><option>Arial</option><option>Georgia</option><option>Times New Roman</option><option>Courier New</option>
              </select>
              <select data-cmd="fontSizePx" aria-label="Tama√±o (Word)">
                <option value="" selected>Tama√±o</option>
                ${wordSizes.map(s=>`<option value="${s}">${s}</option>`).join('')}
              </select>
              <input type="color" value="#0f172a" data-cmd="foreColor" aria-label="Color de texto"/>
            </div>
            <div class="seg">
              <button type="button" data-cmd="bold" title="Negrita"><strong>B</strong></button>
              <button type="button" data-cmd="italic" title="Cursiva"><em>I</em></button>
              <button type="button" data-cmd="underline" title="Subrayado"><u>U</u></button>
              <button type="button" data-cmd="insertUnorderedList" title="Lista">‚Ä¢ Lista</button>
              <button type="button" data-cmd="createLink" title="Enlace">Link</button>
            </div>
          `;

          // Cambios en selects/colores
          tb.addEventListener('change', (e)=>{
            const cmd = e.target.getAttribute('data-cmd');
            if(!cmd) return;

            if(cmd === 'fontName'){
              ensureSelectionInEditor(editor);
              if(e.target.value) document.execCommand('fontName', false, e.target.value);
            }else if(cmd === 'fontSizePx'){
              const val = e.target.value;
              if(val){
                ensureSelectionInEditor(editor);
                applyInlineStyle(editor, 'fontSize', val+'pt');
              }
            }else if(cmd === 'foreColor'){
              ensureSelectionInEditor(editor);
              document.execCommand('foreColor', false, e.target.value);
            }
            updateToolbarStates(editor, tb);
            saveSelection(editor);
          });

          // Botones: pointerdown para capturar antes del blur; siempre garantizamos selecci√≥n dentro del editor
          tb.addEventListener('pointerdown', (e)=>{
            const btn = e.target.closest('button[data-cmd]');
            if(!btn) return;
            e.preventDefault(); // evita perder selecci√≥n/foco
            const cmd = btn.getAttribute('data-cmd');

            ensureSelectionInEditor(editor);

            if(cmd === 'createLink'){
              const url = prompt('Pega la URL (http(s)://)');
              if(url) document.execCommand('createLink', false, url);
            }else{
              document.execCommand(cmd, false, null); // toggles (bold/italic/underline/list)
            }
            updateToolbarStates(editor, tb);
            saveSelection(editor);
          });

          // Guarda selecci√≥n activamente cuando el usuario edita
          ['keyup','mouseup','input'].forEach(ev=>{
            editor.addEventListener(ev, ()=>{
              saveSelection(editor);
              updateToolbarStates(editor, tb);
            });
          });
          editor.addEventListener('focus', ()=>{
            if(!lastSelectionMap.get(editor)) placeCaretAtEnd(editor);
            saveSelection(editor);
            updateToolbarStates(editor, tb);
          });
          document.addEventListener('selectionchange', ()=>{
            const active = document.activeElement;
            if(active === editor){
              saveSelection(editor);
              updateToolbarStates(editor, tb);
            }
          });

          // Inicial: coloca caret al final para que los botones funcionen sin clic previo
          placeCaretAtEnd(editor);
          saveSelection(editor);
          updateToolbarStates(editor, tb);
        }

        makeToolbar('company-desc', 'toolbar-company-desc');
        makeToolbar('proy-desc', 'toolbar-proy-desc');
        makeToolbar('prod-desc', 'toolbar-prod-desc');

        /* ========= Descripci√≥n (conteo) ========= */
        function countWordsFromHTML(html){
          const txt = (html||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
          return txt ? txt.split(' ').length : 0;
        }
        function updateWordCount(){
          const n = countWordsFromHTML(descEditor.innerHTML);
          wordCountEl.textContent = `${n} / 1000 palabras`;
          if(n>1000){ wordCountEl.style.color='var(--err)'; saveBtn.disabled=true; }
          else { wordCountEl.style.color='var(--muted)'; saveBtn.disabled=false; }
        }
        ['input','keyup','mouseup','change','paste'].forEach(evt=>{
          descEditor.addEventListener(evt, updateWordCount);
        });

        /* ========= Estado ========= */

        // helpers
        function uid(){ return (Date.now().toString(36)+Math.random().toString(36).slice(2,7)); }
        function readFilesAsDataUrls(fileList){
          const files = Array.from(fileList||[]);
          return Promise.all(files.map(f=>{
            return new Promise(res=>{
              const r = new FileReader();
              r.onload = e => res(e.target.result);
              r.readAsDataURL(f);
            });
          }));
        }

        /* ======= Gestor de file inputs con preview y quitar ======= */
        function setupImagePicker(inputEl, previewEl){
          let files = []; // estado editable

          function render(){
            previewEl.innerHTML = '';
            files.forEach((file, idx)=>{
              const url = URL.createObjectURL(file);
              const wrap = document.createElement('div');
              wrap.className = 'thumb';
              wrap.innerHTML = `
                <img src="${url}" alt="" height="110" />
                <button type="button" class="rm" aria-label="Quitar imagen" data-idx="${idx}">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                  </svg>
                </button>`;
              previewEl.appendChild(wrap);
            });
          }

          function syncToInput(){
            const dt = new DataTransfer();
            files.forEach(f => dt.items.add(f));
            inputEl.files = dt.files;
          }

          inputEl.addEventListener('change', ()=>{
            files = [...files, ...Array.from(inputEl.files||[])];
            syncToInput();
            render();
          });

          previewEl.addEventListener('click', (e)=>{
            const btn = e.target.closest('.rm');
            if(!btn) return;
            const idx = +btn.getAttribute('data-idx');
            files.splice(idx,1);
            syncToInput();
            render();
          });

          return {
            reset(){ files = []; syncToInput(); render(); }
          };
        }

        function createItemCardHTML(item){
          const imagesHTML = (item.imagenes && item.imagenes.length)
            ? `<div class="gallery-row">${item.imagenes.map(src=>`<img src="${src}" alt="">`).join('')}</div>`
            : '';
          const htmlDesc = item.descripcion || '';
          return `
            <div class="section-bd">
              <div class="item-head">
                <div class="item-title">${item.titulo || 'Sin t√≠tulo'}</div>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="edit-btn" title="Editar" data-id="${item.id}" aria-label="Editar">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M12 20h9"/><path d="M16.5 3.5l4 4L7 21l-4 1 1-4L16.5 3.5z"/>
                    </svg>
                  </button>
                  <button class="delete-btn" title="Borrar" data-id="${item.id}" aria-label="Borrar">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                      stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                  </button>
                </div>
              </div>
              ${imagesHTML}
              <div class="item-desc">${htmlDesc}</div>
            </div>
          `;
        }

        function appendCard(listId, item){
          const list = document.getElementById(listId);
          const card = document.createElement('article');
          card.className = 'card';
          card.style.marginTop = '8px';
          card.setAttribute('data-id', item.id);
          card.innerHTML = createItemCardHTML(item);
          list.appendChild(card);
        }

        function hydrate(){
          bannerEl.style.backgroundImage = current.banner ? `url(${current.banner})` : defaultBanner;
          logoEl.src = current.logo || defaultLogo;

          // üëá controla la visibilidad inicial del hint
          bannerHint.style.display = current.banner ? 'none' : '';

          nameInput.value = current.name || '';
          descEditor.innerHTML = current.desc || '';
          // Tras hidratar, garantizamos caret para que la toolbar funcione al instante
          placeCaretAtEnd(descEditor);
          saveSelection(descEditor);
          updateWordCount();

          selected.clear(); (current.tags||[]).forEach(t=>selected.add(t)); renderActiveTags(); updateSummary();

          if (window.countryData && current.country){
            country.value = current.country;
            const evt=new Event('change'); country.dispatchEvent(evt);
          }
          if(current.region){ setTimeout(()=>{ region.value = current.region; }, 0); }

          (current.proyectos||[]).forEach(p=> appendCard('proyectos-list', p));
          (current.productos||[]).forEach(p=> appendCard('productos-list', p));
        }
        hydrate();

        // === Inicializa pickers de los modales ===
        const proyPicker = setupImagePicker(
          document.getElementById('proy-fotos'),
          document.getElementById('proy-fotos-preview')
        );
        const prodPicker = setupImagePicker(
          document.getElementById('prod-fotos'),
          document.getElementById('prod-fotos-preview')
        );

        // Resets r√°pidos al cerrar modales (los reutilizaremos)
        function resetProyectoModal(){
          document.getElementById('proy-nombre').value='';
          document.getElementById('proy-desc').innerHTML='';
          document.getElementById('proy-fotos').value='';
          proyPicker.reset();
        }
        function resetProductoModal(){
          document.getElementById('prod-nombre').value='';
          document.getElementById('prod-desc').innerHTML='';
          document.getElementById('prod-fotos').value='';
          prodPicker.reset();
        }

        /* ========= Scroll con offset del banner + activo en √≠ndice ========= */
        function getBannerHeight(){
          const v = getComputedStyle(document.documentElement).getPropertyValue('--banner-h').trim();
          const n = parseInt(v, 10);
          return isNaN(n) ? 0 : n;
        }
        document.querySelectorAll('.side-nav a[href^="#"]').forEach(a=>{
          a.addEventListener('click', (e)=>{
            const href = a.getAttribute('href');
            if(href === '/templates/index.html') return;
            e.preventDefault();
            const id = href.slice(1);
            const el = document.getElementById(id);
            if(!el) return;
            const y = el.getBoundingClientRect().top + window.scrollY - getBannerHeight();
            window.scrollTo({ top: y, behavior: 'smooth' });
          });
        });

        const sections = ['sec-nombre','sec-desc','sec-tags','sec-local','sec-proyectos','sec-productos'];
        const navLinks = Array.from(document.querySelectorAll('.side-nav a[href^="#"]'));
        const obs = new IntersectionObserver((entries)=>{
          entries.forEach(entry=>{
            const id = entry.target.id;
            const link = navLinks.find(a=> a.getAttribute('href') === '#'+id);
            if(!link) return;
            if(entry.isIntersecting){
              navLinks.forEach(l=> l.classList.remove('active'));
              link.classList.add('active');
            }
          });
        }, { rootMargin: `-${getBannerHeight()+20}px 0px -60% 0px`, threshold: 0.1 });
        sections.forEach(id=>{
          const el = document.getElementById(id);
          if(el) obs.observe(el);
        });

        /* ========= Modales ========= */
        const openProyecto = document.getElementById('open-proyecto');
        const openProducto = document.getElementById('open-producto');
        const modalProyecto = document.getElementById('modal-proyecto');
        const modalProducto = document.getElementById('modal-producto');

        function openModal(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
        function closeModal(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); }

        openProyecto.addEventListener('click', ()=> openModal(modalProyecto));
        openProducto.addEventListener('click', ()=> openModal(modalProducto));

        document.querySelectorAll('[data-close]').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const sel = btn.getAttribute('data-close');
            const m = document.querySelector(sel);
            if(m) closeModal(m);
            if(m === modalProyecto){
              resetProyectoModal();
              editing = null;
              tempExistingImages = [];
            }
            if(m === modalProducto){
              resetProductoModal();
              editing = null;
              tempExistingImages = [];
            }
          });
        });

        window.addEventListener('click', (e)=>{
          if(e.target === modalProyecto){
            closeModal(modalProyecto);
            resetProyectoModal();
            editing = null;
            tempExistingImages = [];
          }
          if(e.target === modalProducto){
            closeModal(modalProducto);
            resetProductoModal();
            editing = null;
            tempExistingImages = [];
          }
        });

        // Guardar PROYECTO (crear o editar)
        document.getElementById('save-proyecto').addEventListener('click', async ()=>{
          const titulo = (document.getElementById('proy-nombre').value || '').trim();
          const descripcion  = document.getElementById('proy-desc').innerHTML || '';
          const nuevas = await filesToDataURLs(document.getElementById('proy-fotos').files);
          const imagenes = (editing && editing.type==='proyectos')
            ? [...tempExistingImages, ...nuevas]
            : nuevas;

          if(editing && editing.type==='proyectos'){
            const arr = current.proyectos || [];
            const idx = editing.idx;
            const old = arr[idx];
            const updated = { ...old, titulo, descripcion, imagenes };
            arr[idx] = updated;
            current.proyectos = arr;
            await saveProfile(current);
            const card = document.querySelector(`#proyectos-list [data-id="${updated.id}"]`);
            if(card) card.innerHTML = createItemCardHTML(updated);
          }else{
            const item = { id: uid(), titulo, descripcion, imagenes };
            current.proyectos = current.proyectos || [];
            current.proyectos.push(item);
            await saveProfile(current);
            appendCard('proyectos-list', item);
          }

          editing = null; tempExistingImages = [];
          closeModal(modalProyecto);
          resetProyectoModal();
        });

        // Guardar PRODUCTO (crear o editar)
        document.getElementById('save-producto').addEventListener('click', async ()=>{
          const titulo = (document.getElementById('prod-nombre').value || '').trim();
          const descripcion  = document.getElementById('prod-desc').innerHTML || '';
          const nuevas = await filesToDataURLs(document.getElementById('prod-fotos').files);
          const imagenes = (editing && editing.type==='productos')
            ? [...tempExistingImages, ...nuevas]
            : nuevas;

          if(editing && editing.type==='productos'){
            const arr = current.productos || [];
            const idx = editing.idx;
            const old = arr[idx];
            const updated = { ...old, titulo, descripcion, imagenes };
            arr[idx] = updated;
            current.productos = arr;
            await saveProfile(current);
            const card = document.querySelector(`#productos-list [data-id="${updated.id}"]`);
            if(card) card.innerHTML = createItemCardHTML(updated);
          }else{
            const item = { id: uid(), titulo, descripcion, imagenes };
            current.productos = current.productos || [];
            current.productos.push(item);
            await saveProfile(current);
            appendCard('productos-list', item);
          }

          editing = null; tempExistingImages = [];
          closeModal(modalProducto);
          resetProductoModal();
        });

        /* ========= Borrado con confirmaci√≥n ========= */
        const confirmModal = document.getElementById('confirm-modal');
        const confirmYes = document.getElementById('confirm-yes');
        let pendingDelete = null; // { type: 'proyectos'|'productos', id: string }

        function openConfirm(data){ pendingDelete = data; openModal(confirmModal); }

        function deleteItemFromState(type, id){
          const arr = current[type] || [];
          const idx = arr.findIndex(x => x.id === id);
          if(idx >= 0){
            arr.splice(idx,1);
            current[type] = arr;
            saveProfile(current);
          }
        }

        function deleteItemFromDOM(id){
          const el = document.querySelector(`[data-id="${id}"]`);
          if(el && el.parentNode){ el.parentNode.removeChild(el); }
        }

        confirmYes.addEventListener('click', ()=>{
          if(pendingDelete){
            deleteItemFromState(pendingDelete.type, pendingDelete.id);
            deleteItemFromDOM(pendingDelete.id);
          }
          pendingDelete = null;
          closeModal(confirmModal);
        });

        // Delegaci√≥n para botones de borrar
        document.getElementById('proyectos-list').addEventListener('click', (e)=>{
          const btn = e.target.closest('.delete-btn');
          if(!btn) return;
          const id = btn.getAttribute('data-id');
          openConfirm({ type: 'proyectos', id });
        });
        document.getElementById('productos-list').addEventListener('click', (e)=>{
          const btn = e.target.closest('.delete-btn');
          if(!btn) return;
          const id = btn.getAttribute('data-id');
          openConfirm({ type: 'productos', id });
        });

        /* ======= Edici√≥n de items ======= */
        let editing = null; // { type:'proyectos'|'productos', id:string, idx:number }
        let tempExistingImages = []; // dataURLs del item actual (se pueden quitar)

        /* Renderiza miniaturas de im√°genes YA guardadas (en edici√≥n) con quitar */
        function renderExistingImages(container){
          container.innerHTML = '';
          tempExistingImages.forEach((src, idx)=>{
            const wrap = document.createElement('div');
            wrap.className = 'thumb';
            wrap.innerHTML = `
              <img src="${src}" alt="" height="110" />
              <button type="button" class="rm" aria-label="Quitar imagen existente" data-idx="${idx}">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
              </button>`;
            container.appendChild(wrap);
          });
        }

        /* Abre modal de edici√≥n con datos precargados */
        function openEdit(type, id){
          const arr = current[type] || [];
          const idx = arr.findIndex(x => x.id === id);
          if(idx < 0) return;
          const item = arr[idx];
          editing = { type, id, idx };
          tempExistingImages = [...(item.imagenes || [])];

          if(type === 'proyectos'){
            document.getElementById('proy-nombre').value = item.titulo || '';
            document.getElementById('proy-desc').innerHTML = item.descripcion || '';
            proyPicker.reset(); // limpiamos nuevas
            openModal(modalProyecto);

            // contenedor de EXISTENTES (si no existe, se crea sobre la marcha, encima del input)
            let holder = document.getElementById('proy-fotos-preview-existing');
            if(!holder){
              holder = document.createElement('div');
              holder.id = 'proy-fotos-preview-existing';
              holder.className = 'gallery-row';
              const fileInput = document.getElementById('proy-fotos');
              fileInput.parentNode.insertBefore(holder, fileInput);
              holder.addEventListener('click', (e)=>{
                const btn = e.target.closest('.rm');
                if(!btn) return;
                const i = +btn.getAttribute('data-idx');
                tempExistingImages.splice(i,1);
                renderExistingImages(holder);
              });
            }
            renderExistingImages(holder);
          }else{
            document.getElementById('prod-nombre').value = item.titulo || '';
            document.getElementById('prod-desc').innerHTML = item.descripcion || '';
            prodPicker.reset();
            openModal(modalProducto);

            let holder = document.getElementById('prod-fotos-preview-existing');
            if(!holder){
              holder = document.createElement('div');
              holder.id = 'prod-fotos-preview-existing';
              holder.className = 'gallery-row';
              const fileInput = document.getElementById('prod-fotos');
              fileInput.parentNode.insertBefore(holder, fileInput);
              holder.addEventListener('click', (e)=>{
                const btn = e.target.closest('.rm');
                if(!btn) return;
                const i = +btn.getAttribute('data-idx');
                tempExistingImages.splice(i,1);
                renderExistingImages(holder);
              });
            }
            renderExistingImages(holder);
          }
        }

        /* Delegaci√≥n para bot√≥n Editar (l√°piz) */
        document.getElementById('proyectos-list').addEventListener('click', (e)=>{
          const btn = e.target.closest('.edit-btn');
          if(!btn) return;
          openEdit('proyectos', btn.getAttribute('data-id'));
        });
        document.getElementById('productos-list').addEventListener('click', (e)=>{
          const btn = e.target.closest('.edit-btn');
          if(!btn) return;
          openEdit('productos', btn.getAttribute('data-id'));
        });

        /* Helper para pasar Files a dataURL (reutilizado al guardar) */
        async function filesToDataURLs(fileList){
          const files = Array.from(fileList||[]);
          const urls = await Promise.all(files.map(f => new Promise(res=>{
            const r = new FileReader();
            r.onload = e => res(e.target.result);
            r.readAsDataURL(f);
          })));
          return urls;
        }

        saveBtn.addEventListener('click', async ()=> {
          const totalWords = countWordsFromHTML(descEditor.innerHTML);
          if (totalWords > 1000){
            alert('La descripci√≥n supera las 1000 palabras.');
            return;
          }
          current = {
            ...current,
            name: nameInput.value.trim(),
            desc: descEditor.innerHTML.trim(),
            tags: Array.from(selected),
            country: country.value || '',
            region: region.value || ''
          };

          try {
            await saveProfile(current);
            alert('Perfil guardado.');
          } catch (e) {
            alert('No se pudo guardar el perfil: ' + (e?.message || e));
            console.error(e);
          }
        });

        // Parallax de orbes
        const orbs = Array.from(document.querySelectorAll('.orb'));
        let raf = 0; const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        function onMove(x, y){ orbs.forEach((el,i)=>{ const depth=(i+1)*0.015; el.style.transform = `translate3d(${(x-0.5)*30*depth}px, ${(y-0.5)*30*depth}px, 0)`; }); }
        function handlePointer(evt){ if(prefersReduced) return; const {innerWidth:w, innerHeight:h}=window; const x=(evt.clientX??(evt.touches?.[0]?.clientX||w/2))/w; const y=(evt.clientY??(evt.touches?.[0]?.clientY||h/2))/h; cancelAnimationFrame(raf); raf=requestAnimationFrame(()=>onMove(x,y)); }
        window.addEventListener('pointermove', handlePointer, {passive:true});
        window.addEventListener('touchmove', handlePointer, {passive:true});

        // Atajo '/'
        window.addEventListener('keydown', (e)=>{ 
          if(e.key==='/' 
            && !/input|textarea|select|div/i.test(document.activeElement.tagName) 
            && !drawer.classList.contains('open')){
            e.preventDefault(); 
            nameInput.focus(); 
          }
        });

      // 7) Al terminar la hidrataci√≥n
      console.log("Perfil cargado para", currentUser, current);
    })().catch(console.error);

  </script>

</body>
</html>
