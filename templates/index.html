<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <link rel="icon" href="{{ url_for('static', filename='assets/oneiron.ico') }}" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ONEIRON — Inicio</title>
  <style>
    :root{
      /* Paleta */
      --bg:#f7f9fc;
      --card:#ffffffee;
      --glass:#ffffffb8;
      --soft:#f3f6fb80;
      --stroke:#d1d9e680;
      --text:#0f172a;
      --muted:#6b7280;

      /* Colores clave */
      --indigo-bright:#6366f1;     /* más claro/brillante para CTAs */
      --indigo-bright-2:#818cf8;
      --sky:#38bdf8;               /* azul cielo para botón Etiquetas */
      --sky-2:#7dd3fc;

      /* Banner (más intenso que la barra) */
      --banner-start:#c7d2fe;
      --banner-end:#a5b4fc;

      /* Barra superior y bandeja de resultados (más claro que banner) */
      --bar-start:#eef2ff;
      --bar-end:#e0e7ff;

      --radius:16px;
      --shadow-xl: 0 10px 30px rgba(20, 24, 60, .12), 0 2px 8px rgba(20,24,60,.08);
      --ring: 0 0 0 6px rgba(79,70,229,.18);

      /* Alturas */
      --header-h: 62px;             /* NUEVO: altura de la barra */
      --banner-h: clamp(160px, 20vh, 360px);            /* misma altura que perfil (≈300px - 2cm) */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color:var(--text); background:var(--bg); -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; overflow-x:hidden;
    }

    /* Fondo decorativo */
    .dream-bg{ position:fixed; inset:0; z-index:-3; overflow:hidden;
      background:
        radial-gradient(1200px 520px at 50% -5%, rgba(79,70,229,.22), transparent 60%),
        radial-gradient(900px 380px at 15% 100%, rgba(37,99,235,.22), transparent 60%),
        radial-gradient(700px 300px at 85% 90%, rgba(56,189,248,.18), transparent 60%),
        linear-gradient(#f9fbff, #f1f5ff 60%, #f7f9fc);
    }
    .stars,.grain{position:absolute; inset:0; pointer-events:none}
    .stars{ background-image:
      radial-gradient(1px 1px at 10% 20%, rgba(38,38,80,.6) 40%, transparent 41%),
      radial-gradient(1px 1px at 30% 70%, rgba(38,38,80,.5) 40%, transparent 41%),
      radial-gradient(1px 1px at 60% 30%, rgba(38,38,80,.55) 40%, transparent 41%),
      radial-gradient(1.2px 1.2px at 80% 60%, rgba(38,38,80,.45) 40%, transparent 41%),
      radial-gradient(0.9px 0.9px at 50% 85%, rgba(38,38,80,.45) 40%, transparent 41%); filter:blur(.2px); opacity:.55; }
    .grain{ mix-blend-mode:soft-light; opacity:.35;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160" viewBox="0 0 160 160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="160" height="160" filter="url(%23n)" opacity="0.08"/></svg>');
      background-size:160px 160px; }
    .orb{position:absolute; filter:blur(24px); opacity:.35; border-radius:999px; will-change:transform;}
    .orb.one{width:380px; height:380px; left:-80px; top:10vh; background:radial-gradient(circle at 30% 30%, #93c5fd, transparent 60%)}
    .orb.two{width:420px; height:420px; right:-120px; top:45vh; background:radial-gradient(circle at 70% 40%, #a5b4fc, transparent 60%)}
    .orb.three{width:300px; height:300px; left:55vw; top:-120px; background:radial-gradient(circle at 30% 70%, #67e8f9, transparent 60%)}
    @keyframes drift{0%{transform:translate3d(0,0,0) rotate(0)}50%{transform:translate3d(0,12px,0) rotate(1deg)}100%{transform:translate3d(0,0,0) rotate(0)}}
    .orb{animation:drift 11s ease-in-out infinite}

    /* Banner principal */
    .hero{
      position:fixed; top:0; left:0; width:100vw; height:var(--banner-h);
      background:linear-gradient(135deg, var(--banner-start), var(--banner-end));
      border-bottom:1px solid var(--stroke);
      display:grid; place-items:center; z-index:8;
    }
    .hero .overlay{ position:absolute; inset:0;
      /* ligera reducción del radial para banner más bajo */
      background:radial-gradient(800px 260px at 50% 0%, rgba(255,255,255,.18), transparent 60%),
                 linear-gradient(to bottom, rgba(255,255,255,.14), rgba(255,255,255,.02));
      pointer-events:none;
    }
    .hero .logo{
      position:absolute; inset:0;
      display:grid;
      align-content:start;             /* NUEVO: alinear arriba del contenedor */
      justify-items:center;            /* centrado horizontal */
      padding-top: calc(var(--header-h) + 14px); /* NUEVO: bajar bajo la barra */
    }
    .hero .logo img{
      /* antes fijo 140px; ahora depende del alto del banner */
      width: calc(var(--banner-h) * 0.46);
      height: calc(var(--banner-h) * 0.46);
      object-fit:contain; border-radius:24px; background:#fff; padding:12px;
      box-shadow:0 12px 30px rgba(15,23,42,.22)
    }

    /* Barra superior (más clara que el banner) */
    header{
      position:fixed; top:0; left:0; right:0; height:var(--header-h); z-index:9;
      display:flex; align-items:center; justify-content:flex-end;
      padding:0 22px; gap:10px;
      background:linear-gradient(135deg, var(--bar-start), var(--bar-end));
      border-bottom:1px solid color-mix(in oklab, var(--stroke) 60%, white 40%);
      backdrop-filter: blur(12px) saturate(1.05);
    }
    .cta{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--stroke);
      background:linear-gradient(135deg, var(--indigo-bright), var(--indigo-bright-2));
      color:#fff; text-decoration:none; box-shadow:0 10px 24px rgba(99,102,241,.35);
      font-weight:600; line-height:1; white-space:nowrap; transition:filter .15s ease, transform .08s ease;
    }
    .cta.secondary{ background:linear-gradient(135deg, var(--indigo-bright), var(--indigo-bright-2)); color:#fff; box-shadow:0 10px 24px rgba(99,102,241,.35); }
    .cta:hover{ filter:brightness(1.05) saturate(1.02); }
    .cta:active{ transform:translateY(1px) }

    /* Flujo principal compacto */
    main{padding: calc(var(--banner-h) + 4px) 22px 70px;}

    /* Toolbar */
    .toolbar-wrap{position:relative; margin-top:4px}
    .toolbar{
      position:relative;
      left:50%;
      width:calc(100vw - 44px);
      margin-left:calc(-50vw + 22px);
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
      padding:14px;
      border:1px solid var(--stroke); background:var(--glass); border-radius: calc(var(--radius) + 4px);
      box-shadow: var(--shadow-xl); backdrop-filter: blur(16px) saturate(1.08);
      overflow-x:auto; overflow-y:hidden; -ms-overflow-style:none; scrollbar-width:none;
    }
    .toolbar::-webkit-scrollbar{display:none}
    .toolbar:before{
      content:""; position:absolute; inset:-1px; border-radius:inherit; z-index:-1;
      background:conic-gradient(from 180deg at 50% 50%, rgba(79,70,229,.35), rgba(37,99,235,.28), rgba(56,189,248,.25), rgba(79,70,229,.35));
      -webkit-mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000);
      -webkit-mask-composite: xor; mask-composite: exclude; padding:1px; opacity:.5;
    }
    .input, select, button{
      border:1px solid var(--stroke);
      background:linear-gradient(180deg, var(--card), var(--soft));
      color:var(--text);
      padding:12px 14px; border-radius:var(--radius);
      outline:none; transition:border-color .15s, background-color .15s, box-shadow .2s, transform .08s;
      box-shadow: 0 1px 0 rgba(0,0,0,.02) inset, 0 6px 14px rgba(15,23,42,.06);
      height:42px;
    }
    .input:focus-visible, select:focus-visible, button:focus-visible{border-color:var(--indigo-bright); box-shadow:var(--ring)}
    .input:active, select:active, button:active{transform:translateY(1px)}
    /* DOBLE de largo para el campo "nombre empresa" */
    .control{position:relative; flex:2 1 420px; min-width:280px}
    .control svg{position:absolute; left:12px; top:50%; transform:translateY(-50%); pointer-events:none; opacity:.8}
    .control input{padding-left:40px; width:50%;} /* <- clave para que se vea más largo */

    /* Botón Etiquetas (azul cielo) */
    .tags-btn{
      display:flex; align-items:center; gap:8px; cursor:pointer; user-select:none;
      background:linear-gradient(135deg, var(--sky), var(--sky-2));
      color:#fff; border-color: color-mix(in oklab, var(--sky) 40%, #ffffff 60%);
      box-shadow:0 8px 20px rgba(56,189,248,.3);
    }

    select{
      appearance:none; padding-right:46px; min-width:200px;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23111827"><path d="M7 10l5 5 5-5"/></svg>');
      background-repeat:no-repeat; background-position:right 12px center; background-size:20px;
    }
    select:disabled{opacity:.55; cursor:not-allowed;}

    .chosen-row{
      position:relative;
      left:50%;
      width:calc(100vw - 44px);
      margin-left:calc(-50vw + 22px);
      margin-top:6px; padding:0 4px;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center
    }
    .chip{ display:inline-flex; align-items:center; gap:8px; border:1px solid var(--stroke); background:linear-gradient(180deg, #fff, #f8fafc); padding:6px 10px; border-radius:999px; font-size:.9rem; }
    .chip .x{ border:0; background:transparent; padding:2px; cursor:pointer; line-height:0; display:grid; place-items:center; }
    .chip .x svg{ opacity:.8 }

    /* Bandeja de resultados (igual que la barra superior) */
    .results{
      position:relative; margin-top:8px;
      left:50%;
      width:calc(100vw - 44px);
      margin-left:calc(-50vw + 22px);
      min-height:42vh;
      border:1px solid var(--stroke);
      border-radius:22px;
      background:linear-gradient(180deg, var(--bar-start), var(--bar-end));
      box-shadow: var(--shadow-xl);
      overflow:hidden;
    }

    /* Drawer */
    .drawer-overlay{ position:fixed; inset:0; background:radial-gradient(1200px 700px at 20% 50%, rgba(79,70,229,.12), transparent 60%), rgba(2,6,23,.28);
      backdrop-filter: blur(3px); opacity:0; pointer-events:none; transition:opacity .25s ease; z-index:20; }
    .drawer-overlay.open{ opacity:1; pointer-events:auto; }
    .drawer{ position:fixed; top:0; left:0; height:100dvh; width:clamp(320px, 33.33vw, 520px); transform:translateX(-102%);
      transition: transform .32s cubic-bezier(.2,.8,.2,1); z-index:21; display:flex; flex-direction:column;
      border-right:1px solid var(--stroke); background:linear-gradient(180deg, var(--card), var(--soft)); box-shadow:var(--shadow-xl); }
    .drawer.open{ transform:translateX(0); }
    .drawer .hd{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; position:relative; }
    .drawer .hd h2{ font-size:1.05rem; margin:0; letter-spacing:.3px; }
    .drawer .close{ border:1px solid var(--stroke); background:var(--card); border-radius:12px; padding:8px; cursor:pointer; }
    .drawer .content{ padding:12px 12px 18px 12px; overflow:auto; scrollbar-gutter:stable; }
    .picker{ display:grid; grid-template-columns:1fr; gap:12px; }
    .picker label{ display:grid; gap:6px; font-size:.9rem; color:var(--muted); }
    .picker .actions{ display:flex; gap:8px; align-items:center; }
    .picker .add{ background:linear-gradient(135deg, rgba(79,70,229,.95), rgba(37,99,235,.95)); color:#fff; border:0; border-radius:12px; padding:10px 14px; cursor:pointer; box-shadow:0 8px 20px rgba(79,70,229,.22); }
    .clear{ border:1px solid var(--stroke); background:#fff; border-radius:12px; padding:10px 12px; cursor:pointer; }

    @media (prefers-reduced-motion: reduce){ .orb{animation:none} .drawer{transition:none} }
  </style>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/cards.css') }}">
</head>
<body>
  <div class="dream-bg" aria-hidden="true">
    <div class="orb one"></div>
    <div class="orb two"></div>
    <div class="orb three"></div>
    <div class="stars"></div>
    <div class="grain"></div>
  </div>

  <!-- Cabecera visual -->
  <div class="hero" role="img" aria-label="Imagen de cabecera">
    <div class="overlay"></div>
    <div class="logo"><img alt="ONEIRON" src={{ url_for('static', filename='assets/oneiron.png') }}/></div>
  </div>

  <!-- Navegación -->
  <header>
    <a class="cta secondary" href="./login.html" aria-label="Iniciar sesión">Iniciar sesión</a>
    <a class="cta" href="./signup.html" aria-label="Crear cuenta">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Crear cuenta
    </a>
  </header>

  <!-- Drawer de etiquetas -->
  <div id="drawer-overlay" class="drawer-overlay" aria-hidden="true"></div>
  <aside id="tags-drawer" class="drawer" role="dialog" aria-modal="true" aria-labelledby="drawer-title" aria-hidden="true">
    <div class="hd">
      <h2 id="drawer-title">Etiquetas por sector</h2>
      <button class="close" id="drawer-close" aria-label="Cerrar">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="content">
      <div class="picker" aria-label="Selector de etiquetas">
        <label>Sector
          <select id="sector-select">
            <option value="" selected disabled>elige un sector…</option>
          </select>
        </label>
        <label>Subsector
          <select id="subsector-select" disabled>
            <option value="" selected>elige un subsector…</option>
          </select>
        </label>
        <div class="actions">
          <button id="add-chip" class="add" type="button">Añadir etiqueta</button>
          <button id="drawer-clear" class="clear" type="button">Limpiar seleccionadas</button>
        </div>
      </div>
    </div>
    <div class="ft" style="padding:0 12px 12px">
      <span class="summary" id="drawer-summary">0 etiquetas seleccionadas</span>
    </div>
  </aside>

  <main>
    <!-- Buscador y filtros -->
    <div class="toolbar-wrap">
      <div class="toolbar">
        <label class="control" aria-label="Buscar por nombre de empresa">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
          <input id="search" class="input" type="search" placeholder="nombre empresa" autocomplete="off" />
        </label>

        <button id="add-tags" type="button" class="tags-btn" title="Añadir etiquetas" aria-expanded="false" aria-controls="tags-drawer">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          <span id="tags-label">etiquetas</span>
        </button>

        <label aria-label="Seleccionar país">
          <select id="country">
            <!-- NUEVO: opción predeterminada seleccionable (no deshabilitada) -->
            <option value="" selected>país</option>
          </select>
        </label>

        <label aria-label="Seleccionar provincia o estado">
          <select id="region" disabled>
            <option value="" selected>provincia / estado</option>
          </select>
        </label>
      </div>
      <div id="active-tags" class="chosen-row" aria-live="polite"></div>
    </div>

    <!-- Resultados -->
    <section id="results" class="results cards"></section>
  </main>

  <!-- Lógica -->
  <script src="{{ url_for('static', filename='js/countries.js') }}"></script>
  <script src="{{ url_for('static', filename='js/sectors.js') }}"></script>
  <script>
    window.ONEIRON_DEFAULT_LOGO= "{{ url_for('static', filename= 'assets/oneiron.png') }}";
    window.ONEIRON_PROFILE_VIE_URL= "{{ url_for('show_file', file_name='perfil-empresa.html')}}"
  </script>
  
  <script src="{{ url_for('static', filename='js/cards.js') }}"></script>

  <script>
    initSupabaseStorage({
      url: 'https://voopwvocicowmzjvxaey.supabase.co',
      anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZvb3B3dm9jaWNvd216anZ4YWV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTYxOTMsImV4cCI6MjA3MTg5MjE5M30.sYbSaJa7kJSFKFI6Bm29hsJBX3OocAHqmxken3YnAuA'
    }).then(() => {

      (function(){
        const $ = (id) => document.getElementById(id);

        /* Países / regiones */
        const country = $('country');
        const region = $('region');
        const searchInput = $('search');

        if (window.countryData) {
          Object.keys(window.countryData).sort().forEach(p => {
            const opt = document.createElement('option');
            opt.value = p; opt.textContent = p; country.appendChild(opt);
          });

          country.addEventListener('change', () => {
            const sel = country.value;
            region.innerHTML = '<option value="" selected>provincia / estado</option>';
            if (!sel){ 
              // volver al estado predeterminado
              region.disabled = true; 
              applyFilters(); 
              return; 
            }
            window.countryData[sel].forEach(r => {
              const o = document.createElement('option');
              o.value = r; o.textContent = r; region.appendChild(o);
            });
            region.disabled = false;
            applyFilters();
          }, { passive:true });

          region.addEventListener('change', () => applyFilters(), { passive:true });
        }

        /* Drawer de etiquetas */
        const drawer = $('tags-drawer');
        const overlay = $('drawer-overlay');
        const tagsBtn = $('add-tags');
        const drawerClose = $('drawer-close');
        const drawerSummary = $('drawer-summary');
        const tagsLabel = $('tags-label');
        const activeTags = $('active-tags');

        const sectorSelect = $('sector-select');
        const subSelect = $('subsector-select');
        const addChipBtn = $('add-chip');
        const clearBtn = $('drawer-clear');

        // SIN fallback: si falta sectors.js, se deja deshabilitado
        const sectors = (window.sectorData && typeof window.sectorData === 'object' && Object.keys(window.sectorData).length)
          ? window.sectorData
          : null;

        function populateSectors(){
          sectorSelect.innerHTML = '<option value="" selected disabled>elige un sector…</option>';
          if (!sectors){
            sectorSelect.disabled = true;
            subSelect.innerHTML = '<option value="" selected>elige un subsector…</option>';
            subSelect.disabled = true;
            addChipBtn.disabled = true;
            return;
          }
          Object.keys(sectors).forEach(s => {
            const o = document.createElement('option'); o.value = s; o.textContent = s; sectorSelect.appendChild(o);
          });
          sectorSelect.disabled = false;
          subSelect.innerHTML = '<option value="" selected>elige un subsector…</option>';
          subSelect.disabled = true;
          addChipBtn.disabled = false;
        }
        populateSectors();

        sectorSelect.addEventListener('change', ()=>{
          const s = sectorSelect.value;
          subSelect.innerHTML = '<option value="" selected>elige un subsector…</option>';
          if(!s){ subSelect.disabled = true; return; }
          (sectors[s] || []).forEach(sub => {
            const o = document.createElement('option'); o.value = sub; o.textContent = sub; subSelect.appendChild(o);
          });
          subSelect.disabled = false;
          subSelect.focus();
        }, { passive:true });

        const selected = new Set();

        function renderActiveTags(){
          activeTags.innerHTML = '';
          selected.forEach(tag => {
            const chip = document.createElement('span');
            chip.className = 'chip';
            chip.innerHTML = `${tag} <button class="x" aria-label="Quitar ${tag}" data-tag="${tag}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>`;
            activeTags.appendChild(chip);
          });
        }
        function updateSummary(){
          const n = selected.size;
          drawerSummary.textContent = `${n} etiqueta${n!==1?'s':''} seleccionada${n!==1?'s':''}`;
          tagsLabel.textContent = n ? `etiquetas (${n})` : 'etiquetas';
        }
        function addCurrentSelection(){
          const sector = sectorSelect.value;
          const sub = subSelect.value;
          if(!sector || !sub) return;
          const label = `${sector}: ${sub}`;
          if(!selected.has(label)){
            selected.add(label);
            renderActiveTags();
            updateSummary();
            applyFilters();
          }
        }

        addChipBtn.addEventListener('click', addCurrentSelection);
        activeTags.addEventListener('click', (e)=>{
          const btn = e.target.closest('button.x');
          if(!btn) return;
          const tag = btn.getAttribute('data-tag');
          selected.delete(tag);
          renderActiveTags();
          updateSummary();
          applyFilters();
        });
        clearBtn.addEventListener('click', ()=>{
          selected.clear();
          renderActiveTags();
          updateSummary();
          applyFilters();
        });

        function openDrawer(){
          drawer.classList.add('open');
          overlay.classList.add('open');
          drawer.removeAttribute('aria-hidden');
          overlay.removeAttribute('aria-hidden');
          tagsBtn.setAttribute('aria-expanded', 'true');
          setTimeout(()=>{ sectorSelect.focus(); }, 80);
        }
        function closeDrawer(){
          drawer.classList.remove('open');
          overlay.classList.remove('open');
          drawer.setAttribute('aria-hidden','true');
          overlay.setAttribute('aria-hidden','true');
          tagsBtn.setAttribute('aria-expanded', 'false');
          tagsBtn.focus();
        }

        tagsBtn.addEventListener('click', (ev) => {
          ev.preventDefault();
          try {
            tagsBtn.animate(
              [{ transform:'translateY(0) scale(1)' },{ transform:'translateY(1px) scale(0.98)' },{ transform:'translateY(0) scale(1)' }],
              { duration:220, easing:'ease-out' }
            );
          } catch(_) {}
          openDrawer();
        });

        drawerClose.addEventListener('click', closeDrawer);
        overlay.addEventListener('click', closeDrawer);
        window.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape' && drawer.classList.contains('open')){ closeDrawer(); }
          if(e.key === 'Enter' && drawer.classList.contains('open')){ addCurrentSelection(); }
        });

        /* Atajo para enfocar buscador */
        window.addEventListener('keydown', (e) => {
          const tagName = document.activeElement?.tagName || '';
          if(e.key === '/' && !/input|textarea/i.test(tagName) && !drawer.classList.contains('open')){
            e.preventDefault();
            searchInput?.focus();
          }
        });

        /* Parallax sutil */
        const orbs = Array.from(document.querySelectorAll('.orb'));
        const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        let raf = 0;
        function onMove(x, y){
          orbs.forEach((el, i)=>{ const depth = (i+1) * 0.015; el.style.transform = `translate3d(${(x-0.5)*30*depth}px, ${(y-0.5)*30*depth}px, 0)`; });
        }
        function handlePointer(evt){
          if(prefersReduced) return;
          const { innerWidth:w, innerHeight:h } = window;
          const pt = evt.touches?.[0] || evt;
          const x = (pt.clientX ?? w/2) / w;
          const y = (pt.clientY ?? h/2) / h;
          cancelAnimationFrame(raf);
          raf = requestAnimationFrame(()=>onMove(x,y));
        }
        window.addEventListener('pointermove', handlePointer, { passive:true });
        window.addEventListener('touchmove', handlePointer, { passive:true });

        /* ------------ FILTROS EN RESULTADOS ------------ */

        const resultsEl = $('results');

        function norm(s){
          return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}+/gu,'').toLowerCase().trim();
        }

        function getCardData(card){
          // 1) data-attributes si existen
          const name = card.dataset.name || card.getAttribute('data-name') || '';
          const country = card.dataset.country || card.getAttribute('data-country') || '';
          const regionVal = card.dataset.region || card.getAttribute('data-region') || '';
          let tagsAttr = card.dataset.tags || card.getAttribute('data-tags') || '';

          let tags = [];
          if(tagsAttr){
            try{
              // puede venir como JSON ["A","B"] o como "A,B"
              const parsed = JSON.parse(tagsAttr);
              if(Array.isArray(parsed)) tags = parsed.map(String);
            }catch{
              tags = tagsAttr.split(',').map(s=>s.trim()).filter(Boolean);
            }
          }

          // 2) Si faltan campos, intenta extraer del contenido
          const nameFallback = card.querySelector('[data-field="name"]')?.textContent
                            || card.querySelector('.title, h3, h2')?.textContent
                            || '';
          const countryFallback = card.querySelector('[data-field="country"]')?.textContent || '';
          const regionFallback = card.querySelector('[data-field="region"]')?.textContent || '';

          if(tags.length === 0){
            const tagNodes = card.querySelectorAll('[data-tag], .tag, .chip, .badge');
            tags = Array.from(tagNodes).map(n => (n.getAttribute('data-tag') || n.textContent || '').trim()).filter(Boolean);
          }

          return {
            name: name || nameFallback,
            country: country || countryFallback,
            region: regionVal || regionFallback,
            tags
          };
        }

        function cardMatches(card){
          const q = norm(searchInput?.value || '');
          const wantCountry = country.value || '';
          const wantRegion  = region.value || '';

          const wantedTags = Array.from(selected);

          const { name, country: ctry, region: reg, tags } = getCardData(card);

          const nameOk = !q || norm(name).includes(q);
          const countryOk = !wantCountry || norm(ctry) === norm(wantCountry);
          const regionOk  = !wantRegion  || norm(reg)  === norm(wantRegion);

          // Cada etiqueta seleccionada debe estar presente en las etiquetas del card
          const tagSet = new Set(tags.map(t=>norm(t)));
          const tagsOk = wantedTags.every(t => tagSet.has(norm(t)));

          return nameOk && countryOk && regionOk && tagsOk;
        }

        function applyFilters(){
          const cards = resultsEl?.children ? Array.from(resultsEl.children) : [];
          cards.forEach(card=>{
            // oculta elementos que no son tarjetas (p.ej. placeholders)
            if(!(card instanceof HTMLElement)) return;
            const show = cardMatches(card);
            card.style.display = show ? '' : 'none';
          });
        }

        // Dispara filtrado al escribir en el buscador
        searchInput?.addEventListener('input', () => applyFilters());

        // Si otro script (cards.js) inyecta tarjetas asincrónicamente, observa cambios y aplica filtro
        const mo = new MutationObserver(() => applyFilters());
        if(resultsEl) mo.observe(resultsEl, { childList:true, subtree:false });

        // Primer filtrado por si hay contenido inicial
        applyFilters();
      })();
    }).catch(console.error);
  </script>

</body>
</html>
